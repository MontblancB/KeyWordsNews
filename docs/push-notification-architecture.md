# 키워드 뉴스 알림 시스템 아키텍처

## 목차

1. [시스템 아키텍처 개요](#1-시스템-아키텍처-개요)
2. [클라이언트 레이어 아키텍처](#2-클라이언트-레이어-아키텍처)
3. [서버 레이어 아키텍처](#3-서버-레이어-아키텍처)
4. [데이터베이스 아키텍처](#4-데이터베이스-아키텍처)
5. [알림 전송 아키텍처](#5-알림-전송-아키텍처)
6. [보안 아키텍처](#6-보안-아키텍처)
7. [에러 처리 및 복구](#7-에러-처리-및-복구)
8. [성능 고려사항](#8-성능-고려사항)
9. [모니터링 및 분석](#9-모니터링-및-분석)
10. [구현 계획](#10-구현-계획)

---

## 1. 시스템 아키텍처 개요

### 1.1 현재 상태 분석

| 항목 | 현재 상태 |
|------|----------|
| Service Worker | ❌ 없음 |
| PWA 패키지 | ❌ 미설치 |
| 키워드 저장 | 🟡 localStorage만 사용 (서버 미연동) |
| RSS 수집 | ✅ 10분마다 자동 실행 |
| 데이터베이스 | ✅ Prisma + PostgreSQL |

### 1.2 전체 시스템 다이어그램

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                   사용자 디바이스                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                              브라우저 (PWA)                              │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │    │
│  │  │   React     │  │  React      │  │ localStorage│  │  Service    │     │    │
│  │  │   App       │◄─┤  Query      │  │  (키워드)   │  │  Worker     │     │    │
│  │  │             │  │  (캐시)     │  │             │  │  (sw.js)    │     │    │
│  │  └──────┬──────┘  └─────────────┘  └──────┬──────┘  └──────┬──────┘     │    │
│  │         │                                 │                 │            │    │
│  │         │ HTTP 요청                       │ 동기화          │ Push 수신  │    │
│  └─────────┼─────────────────────────────────┼─────────────────┼────────────┘    │
│            │                                 │                 │                 │
└────────────┼─────────────────────────────────┼─────────────────┼─────────────────┘
             │                                 │                 │
             ▼                                 ▼                 │
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Vercel (Next.js 서버)                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                            API Routes                                    │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │    │
│  │  │ /api/push   │  │ /api/push   │  │ /api/rss    │  │ /api/news   │     │    │
│  │  │ /subscribe  │  │ /keywords   │  │ /collect    │  │ /*          │     │    │
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └─────────────┘     │    │
│  │         │                │                │                              │    │
│  │         ▼                ▼                ▼                              │    │
│  │  ┌───────────────────────────────────────────────────────────────┐      │    │
│  │  │                     비즈니스 로직 레이어                        │      │    │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐    │      │    │
│  │  │  │ 구독 관리   │  │ 키워드 매칭 │  │ 푸시 알림 전송      │    │      │    │
│  │  │  │ Service     │  │ Engine      │  │ (web-push 라이브러리)│    │      │    │
│  │  │  └─────────────┘  └─────────────┘  └──────────┬──────────┘    │      │    │
│  │  └───────────────────────────────────────────────┼───────────────┘      │    │
│  │                                                  │                       │    │
│  └──────────────────────────────────────────────────┼───────────────────────┘    │
│                                                     │                            │
│  ┌──────────────────────────────────────────────────┼───────────────────────┐    │
│  │                        Prisma ORM                │                       │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │    │
│  │  │ News        │  │ Push        │  │ User        │  │ Notification│     │    │
│  │  │ (뉴스)      │  │ Subscription│  │ Keyword     │  │ Log         │     │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘     │    │
│  └──────────────────────────────────────────────────────────────────────────┘    │
│                                          │                                       │
└──────────────────────────────────────────┼───────────────────────────────────────┘
                                           │
                                           ▼
┌──────────────────────────────────────────────────────────────────────────────────┐
│                           Vercel Postgres (PostgreSQL)                           │
└──────────────────────────────────────────────────────────────────────────────────┘

                                           ▲
                                           │ 푸시 요청
┌──────────────────────────────────────────┼───────────────────────────────────────┐
│                              Push Service Provider                               │
│  ┌─────────────────────────┐  ┌─────────────────────────┐                       │
│  │ FCM (Firebase Cloud     │  │ APNs (Apple Push       │                        │
│  │ Messaging) - Android    │  │ Notification) - iOS    │                        │
│  └─────────────────────────┘  └─────────────────────────┘                       │
└──────────────────────────────────────────────────────────────────────────────────┘

                                           ▲
                                           │ 10분마다 트리거
┌──────────────────────────────────────────┼───────────────────────────────────────┐
│                              GitHub Actions                                      │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  collect-rss.yml (Cron: */10 * * * *)                                   │    │
│  │  → POST /api/rss/collect (x-cron-secret 헤더 포함)                      │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 클라이언트 레이어 아키텍처

### 2.1 브라우저 컴포넌트 구조

```
┌─────────────────────────────────────────────────────────────────┐
│                        브라우저 환경                             │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    Main Thread (UI)                       │  │
│  │                                                           │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │              Next.js React Application              │  │  │
│  │  │                                                     │  │  │
│  │  │  ┌─────────────┐    ┌─────────────────────────────┐ │  │  │
│  │  │  │   Pages     │    │      Components             │ │  │  │
│  │  │  │             │    │                             │ │  │  │
│  │  │  │ • /         │    │ • PushNotificationPrompt    │ │  │  │
│  │  │  │ • /keywords │    │ • PushSettings              │ │  │  │
│  │  │  │ • /settings │    │ • KeywordManager            │ │  │  │
│  │  │  └─────────────┘    └─────────────────────────────┘ │  │  │
│  │  │         │                        │                  │  │  │
│  │  │         ▼                        ▼                  │  │  │
│  │  │  ┌─────────────────────────────────────────────────┐│  │  │
│  │  │  │              Custom Hooks Layer                 ││  │  │
│  │  │  │                                                 ││  │  │
│  │  │  │  ┌─────────────────┐  ┌─────────────────────┐  ││  │  │
│  │  │  │  │usePushSubscription│  │ useKeywords        │  ││  │  │
│  │  │  │  │                 │  │                     │  ││  │  │
│  │  │  │  │ • subscribe()   │  │ • keywords[]       │  ││  │  │
│  │  │  │  │ • unsubscribe() │  │ • addKeyword()     │  ││  │  │
│  │  │  │  │ • syncKeywords()│  │ • deleteKeyword()  │  ││  │  │
│  │  │  │  │ • isSubscribed  │  │                     │  ││  │  │
│  │  │  │  └────────┬────────┘  └──────────┬──────────┘  ││  │  │
│  │  │  └───────────┼──────────────────────┼─────────────┘│  │  │
│  │  │              │                      │              │  │  │
│  │  └──────────────┼──────────────────────┼──────────────┘  │  │
│  │                 │                      │                 │  │
│  │                 ▼                      ▼                 │  │
│  │  ┌─────────────────────────┐  ┌─────────────────────┐   │  │
│  │  │    Push Manager API     │  │    localStorage     │   │  │
│  │  │                         │  │                     │   │  │
│  │  │ • getSubscription()     │  │ • news_keywords     │   │  │
│  │  │ • subscribe()           │  │ • push_settings     │   │  │
│  │  │ • permissionState()     │  │                     │   │  │
│  │  └─────────────────────────┘  └─────────────────────┘   │  │
│  │                                                          │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                 Service Worker Thread                     │  │
│  │                     (별도 스레드)                          │  │
│  │                                                           │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │                    sw.js                            │  │  │
│  │  │                                                     │  │  │
│  │  │  ┌─────────────────────────────────────────────┐   │  │  │
│  │  │  │           Event Listeners                   │   │  │  │
│  │  │  │                                             │   │  │  │
│  │  │  │  • 'push'    → 알림 수신 & 표시            │   │  │  │
│  │  │  │  • 'notificationclick' → 알림 클릭 처리    │   │  │  │
│  │  │  │  • 'install' → SW 설치                     │   │  │  │
│  │  │  │  • 'activate'→ SW 활성화                   │   │  │  │
│  │  │  └─────────────────────────────────────────────┘   │  │  │
│  │  │                                                     │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 Service Worker 상세 동작

```
┌─────────────────────────────────────────────────────────────────┐
│                     Service Worker 생명주기                      │
│                                                                 │
│   1. 등록 (Registration)                                        │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │  navigator.serviceWorker.register('/sw.js')             │   │
│   │                    │                                     │   │
│   │                    ▼                                     │   │
│   │  ┌─────────────────────────────────────────────────┐    │   │
│   │  │  'install' 이벤트                               │    │   │
│   │  │  → 캐시 프리캐싱 (serwist)                      │    │   │
│   │  │  → self.skipWaiting()                           │    │   │
│   │  └─────────────────────────────────────────────────┘    │   │
│   │                    │                                     │   │
│   │                    ▼                                     │   │
│   │  ┌─────────────────────────────────────────────────┐    │   │
│   │  │  'activate' 이벤트                              │    │   │
│   │  │  → 오래된 캐시 정리                             │    │   │
│   │  │  → self.clients.claim()                         │    │   │
│   │  └─────────────────────────────────────────────────┘    │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│   2. 푸시 알림 수신                                              │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                                                         │   │
│   │   Push Service ──────────────────────────────┐          │   │
│   │   (FCM/APNs)                                 │          │   │
│   │                                              ▼          │   │
│   │   ┌─────────────────────────────────────────────────┐   │   │
│   │   │  'push' 이벤트                                  │   │   │
│   │   │                                                 │   │   │
│   │   │  event.data.json() 파싱:                        │   │   │
│   │   │  {                                              │   │   │
│   │   │    title: "[키워드] 연합뉴스",                   │   │   │
│   │   │    body: "뉴스 제목...",                        │   │   │
│   │   │    tag: "news-abc123",                          │   │   │
│   │   │    url: "https://...",                          │   │   │
│   │   │    newsId: "abc123",                            │   │   │
│   │   │    keyword: "AI"                                │   │   │
│   │   │  }                                              │   │   │
│   │   └─────────────────────────────────────────────────┘   │   │
│   │                         │                               │   │
│   │                         ▼                               │   │
│   │   ┌─────────────────────────────────────────────────┐   │   │
│   │   │  self.registration.showNotification()           │   │   │
│   │   │                                                 │   │   │
│   │   │  옵션:                                          │   │   │
│   │   │  • body: 뉴스 제목                              │   │   │
│   │   │  • icon: /icons/icon-192x192.png               │   │   │
│   │   │  • badge: /icons/icon-72x72.png                │   │   │
│   │   │  • tag: 그룹화 (같은 태그 = 덮어쓰기)           │   │   │
│   │   │  • data: { url, newsId, keyword }              │   │   │
│   │   │  • actions: [{ action: 'open', title: '열기' }]│   │   │
│   │   │  • vibrate: [200, 100, 200]                    │   │   │
│   │   └─────────────────────────────────────────────────┘   │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│   3. 알림 클릭 처리                                              │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │  'notificationclick' 이벤트                             │   │
│   │                                                         │   │
│   │  ┌─────────────────────────────────────────────────┐   │   │
│   │  │  1. event.notification.close()                  │   │   │
│   │  │     → 알림 닫기                                  │   │   │
│   │  │                                                 │   │   │
│   │  │  2. event.action 확인                           │   │   │
│   │  │     → 'dismiss': 아무것도 안함                  │   │   │
│   │  │     → 'open' 또는 기본: URL 열기                │   │   │
│   │  │                                                 │   │   │
│   │  │  3. self.clients.matchAll()                     │   │   │
│   │  │     → 이미 열린 탭 찾기                         │   │   │
│   │  │                                                 │   │   │
│   │  │  4-a. 탭 있음: client.focus()                   │   │   │
│   │  │  4-b. 탭 없음: self.clients.openWindow(url)    │   │   │
│   │  └─────────────────────────────────────────────────┘   │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.3 구독 흐름 (Subscription Flow)

```
┌─────────────────────────────────────────────────────────────────┐
│                       구독 등록 흐름                             │
│                                                                 │
│  사용자                  브라우저                    서버        │
│    │                       │                          │         │
│    │  "알림 받기" 클릭     │                          │         │
│    │──────────────────────>│                          │         │
│    │                       │                          │         │
│    │                       │  Notification.           │         │
│    │                       │  requestPermission()     │         │
│    │                       │         │                │         │
│    │                       │         ▼                │         │
│    │  ┌────────────────────────────────────────┐     │         │
│    │  │     권한 요청 팝업                      │     │         │
│    │  │  "키워드뉴스에서 알림을 보내려고 합니다" │     │         │
│    │  │                                        │     │         │
│    │  │      [허용]  [차단]                    │     │         │
│    │  └────────────────────────────────────────┘     │         │
│    │                       │                          │         │
│    │  "허용" 클릭          │                          │         │
│    │──────────────────────>│                          │         │
│    │                       │                          │         │
│    │                       │  pushManager.subscribe({│         │
│    │                       │    userVisibleOnly: true,│        │
│    │                       │    applicationServerKey  │         │
│    │                       │  })                      │         │
│    │                       │         │                │         │
│    │                       │         ▼                │         │
│    │                       │  PushSubscription 생성   │         │
│    │                       │  {                       │         │
│    │                       │    endpoint: "https://   │         │
│    │                       │      fcm.googleapis.com/ │         │
│    │                       │      fcm/send/...",     │         │
│    │                       │    keys: {               │         │
│    │                       │      p256dh: "...",     │         │
│    │                       │      auth: "..."        │         │
│    │                       │    }                     │         │
│    │                       │  }                       │         │
│    │                       │                          │         │
│    │                       │  POST /api/push/subscribe│         │
│    │                       │──────────────────────────>         │
│    │                       │  {                       │         │
│    │                       │    subscription: {...},  │         │
│    │                       │    keywords: ["AI", ...] │         │
│    │                       │  }                       │         │
│    │                       │                          │         │
│    │                       │                 DB 저장  │         │
│    │                       │                 ┌────────┴───────┐ │
│    │                       │                 │PushSubscription│ │
│    │                       │                 │ • endpoint     │ │
│    │                       │                 │ • p256dh       │ │
│    │                       │                 │ • auth         │ │
│    │                       │                 ├────────────────┤ │
│    │                       │                 │UserKeyword     │ │
│    │                       │                 │ • "AI"         │ │
│    │                       │                 │ • "반도체"     │ │
│    │                       │                 └────────────────┘ │
│    │                       │                          │         │
│    │                       │  환영 알림 전송          │         │
│    │                       │<─────────────────────────│         │
│    │                       │                          │         │
│    │  알림 표시            │                          │         │
│    │<──────────────────────│                          │         │
│    │  "키워드뉴스 알림     │                          │         │
│    │   설정 완료!"         │                          │         │
│    │                       │                          │         │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 서버 레이어 아키텍처

### 3.1 API 라우트 구조

```
app/api/
│
├── push/                      # 푸시 알림 관련
│   │
│   ├── subscribe/             # 구독 관리
│   │   └── route.ts
│   │       │
│   │       ├── POST           │ 새 구독 등록
│   │       │   • endpoint, keys 저장
│   │       │   • 키워드 연결
│   │       │   • 환영 알림 전송
│   │       │
│   │       └── DELETE         │ 구독 취소
│   │           • isActive = false 설정
│   │
│   ├── keywords/              # 키워드 동기화
│   │   └── route.ts
│   │       │
│   │       ├── GET            │ 서버 키워드 조회
│   │       │   • endpoint으로 구독 찾기
│   │       │   • 연결된 키워드 목록 반환
│   │       │
│   │       └── POST           │ 키워드 동기화
│   │           • 기존 키워드 삭제
│   │           • 새 키워드 일괄 생성
│   │
│   ├── send/                  # 알림 전송 (내부용)
│   │   └── route.ts
│   │       │
│   │       └── POST           │ 키워드 매칭 알림 전송
│   │           • x-cron-secret 인증
│   │           • 뉴스-키워드 매칭
│   │           • web-push 전송
│   │
│   ├── status/                # 구독 상태 확인
│   │   └── route.ts
│   │       │
│   │       └── GET            │ 구독 상태 반환
│   │           • endpoint으로 조회
│   │           • isActive, 키워드 수 등
│   │
│   └── test/                  # 테스트 알림
│       └── route.ts
│           │
│           └── POST           │ 테스트 알림 전송
│               • 요청자 구독에만 전송
│
├── rss/                       # RSS 수집
│   └── collect/
│       └── route.ts
│           │
│           └── POST           │ RSS 수집 트리거
│               • x-cron-secret 인증
│               • RSS 수집 실행
│               • 🆕 키워드 알림 전송 호출
│
└── news/                      # 뉴스 API (기존)
    ├── breaking/
    ├── latest/
    ├── category/
    ├── search/
    └── summarize/
```

### 3.2 비즈니스 로직 레이어

```
lib/
│
├── push/                      # 푸시 알림 모듈
│   │
│   ├── vapid.ts               # VAPID 키 설정
│   │   │
│   │   └── VAPID_CONFIG = {
│   │         publicKey: env.NEXT_PUBLIC_VAPID_PUBLIC_KEY,
│   │         privateKey: env.VAPID_PRIVATE_KEY,
│   │         subject: "mailto:..."
│   │       }
│   │
│   ├── sender.ts              # 알림 전송 로직
│   │   │
│   │   ├── sendKeywordNotifications(newsIds)
│   │   │   │
│   │   │   ├── 1. 뉴스 조회 (notificationSent = false)
│   │   │   ├── 2. 활성 구독 + 키워드 조회
│   │   │   ├── 3. 키워드 → 구독 맵 생성
│   │   │   ├── 4. 뉴스별 키워드 매칭
│   │   │   ├── 5. 매칭된 구독자에게 알림 전송
│   │   │   └── 6. 알림 로그 저장 & 뉴스 상태 업데이트
│   │   │
│   │   ├── sendNotificationToSubscription(sub, payload)
│   │   │   │
│   │   │   └── webpush.sendNotification({
│   │   │         endpoint, keys: { p256dh, auth }
│   │   │       }, JSON.stringify(payload))
│   │   │
│   │   └── isQuietHours(start, end)
│   │       │
│   │       └── 방해금지 시간 체크 (예: 22시~7시)
│   │
│   ├── subscription.ts        # 구독 관리 유틸
│   │   │
│   │   ├── createSubscription(data)
│   │   ├── updateSubscription(endpoint, data)
│   │   ├── deactivateSubscription(endpoint)
│   │   └── getActiveSubscriptions()
│   │
│   └── keyword-matcher.ts     # 키워드 매칭 엔진
│       │
│       ├── matchKeywords(text, keywords)
│       │   │
│       │   └── 텍스트에서 키워드 찾기
│       │       • 대소문자 무시
│       │       • 부분 일치
│       │
│       └── buildKeywordIndex(subscriptions)
│           │
│           └── 키워드 → 구독자 역인덱스 생성
│               Map<keyword, subscription[]>
│
├── rss/                       # RSS 수집 모듈 (기존)
│   │
│   ├── collector.ts           # RSS 수집기
│   │   │
│   │   └── collectAll()
│   │       │
│   │       ├── 기존: RSS 수집 → DB 저장
│   │       │
│   │       └── 🆕 추가: 새 뉴스 ID로 알림 전송 호출
│   │           await sendKeywordNotifications(newNewsIds)
│   │
│   ├── parser.ts
│   └── sources.ts
│
└── prisma.ts                  # Prisma 클라이언트
```

---

## 4. 데이터베이스 아키텍처

### 4.1 ERD (Entity Relationship Diagram)

```
┌─────────────────────┐          ┌─────────────────────┐
│       News          │          │  PushSubscription   │
├─────────────────────┤          ├─────────────────────┤
│ id          PK      │          │ id          PK      │
│ title               │          │ endpoint    UNIQUE  │
│ url         UNIQUE  │          │ p256dh              │
│ summary             │          │ auth                │
│ source              │          │ userAgent           │
│ category            │          │ deviceName          │
│ publishedAt         │          │ isActive            │
│ imageUrl            │          │ notifyBreaking      │
│ isBreaking          │          │ notifyKeyword       │
│                     │          │ quietHoursStart     │
│ # AI 요약           │          │ quietHoursEnd       │
│ aiSummary           │          │ createdAt           │
│ aiKeywords[]        │          │ updatedAt           │
│ aiSummarizedAt      │          │ lastActiveAt        │
│ aiProvider          │          └──────────┬──────────┘
│                     │                     │
│ # 🆕 알림 관련      │                     │ 1:N
│ notificationSent    │                     │
│ notificationSentAt  │                     ▼
│ matchedKeywords[]   │          ┌─────────────────────┐
│                     │          │    UserKeyword      │
│ createdAt           │          ├─────────────────────┤
│ updatedAt           │          │ id          PK      │
└──────────┬──────────┘          │ keyword             │
           │                     │ isEnabled           │
           │                     │ subscriptionId  FK  │──┐
           │                     │ createdAt           │  │
           │                     └─────────────────────┘  │
           │                                              │
           │              UNIQUE(subscriptionId, keyword) │
           │                                              │
           │ 1:N                                          │
           │                                              │
           ▼                                              │
┌─────────────────────┐                                   │
│  NotificationLog    │                                   │
├─────────────────────┤                                   │
│ id          PK      │                                   │
│ subscriptionId  FK  │───────────────────────────────────┘
│ newsId              │ (News와 직접 FK 없음, 참조용)
│ title               │
│ body                │
│ keyword             │
│ status              │ (sent, failed, clicked)
│ errorMessage        │
│ clickedAt           │
│ createdAt           │
└─────────────────────┘
```

### 4.2 Prisma 스키마

```prisma
// 푸시 구독 정보 (디바이스별)
model PushSubscription {
  id           String   @id @default(cuid())

  // Web Push API에서 제공하는 구독 정보
  endpoint     String   @unique              // 푸시 서버 엔드포인트
  p256dh       String                        // 암호화 공개키
  auth         String                        // 인증 시크릿

  // 메타 정보
  userAgent    String?                       // 브라우저/디바이스 정보
  deviceName   String?                       // 사용자 지정 이름
  isActive     Boolean  @default(true)       // 활성 상태

  // 알림 설정
  notifyBreaking  Boolean @default(true)     // 속보 알림
  notifyKeyword   Boolean @default(true)     // 키워드 알림
  quietHoursStart Int?                       // 방해금지 시작 (0-23)
  quietHoursEnd   Int?                       // 방해금지 종료 (0-23)

  // 관계
  keywords     UserKeyword[]                 // 등록된 키워드
  notifications NotificationLog[]           // 알림 이력

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  lastActiveAt DateTime @default(now())      // 마지막 활동 시간

  @@index([endpoint])
  @@index([isActive])
}

// 사용자 키워드 (서버 동기화용)
model UserKeyword {
  id              String   @id @default(cuid())
  keyword         String                       // 키워드 텍스트
  isEnabled       Boolean  @default(true)      // 이 키워드 알림 활성화

  // 구독과 연결
  subscriptionId  String
  subscription    PushSubscription @relation(
    fields: [subscriptionId],
    references: [id],
    onDelete: Cascade
  )

  createdAt       DateTime @default(now())

  // 동일 구독에서 키워드 중복 방지
  @@unique([subscriptionId, keyword])
  @@index([keyword])
  @@index([subscriptionId])
}

// 알림 발송 이력 (디버깅 & 분석용)
model NotificationLog {
  id              String   @id @default(cuid())

  // 연결 정보
  subscriptionId  String
  subscription    PushSubscription @relation(
    fields: [subscriptionId],
    references: [id],
    onDelete: Cascade
  )
  newsId          String?                      // 관련 뉴스 ID

  // 알림 내용
  title           String
  body            String
  keyword         String?                      // 매칭된 키워드

  // 상태
  status          String   @default("sent")    // sent, failed, clicked
  errorMessage    String?                      // 실패 시 에러 메시지
  clickedAt       DateTime?                    // 클릭 시간

  createdAt       DateTime @default(now())

  @@index([subscriptionId])
  @@index([newsId])
  @@index([createdAt])
}

// News 모델 수정 (기존 + 알림 필드)
model News {
  // 기존 필드...

  // 🆕 알림 관련 필드
  notificationSent    Boolean   @default(false)
  notificationSentAt  DateTime?
  matchedKeywords     String[]  @default([])

  @@index([notificationSent])
}
```

### 4.3 데이터 흐름

```
1. 구독 등록
┌─────────────────────────────────────────────────────────┐
│                                                         │
│  클라이언트               서버                  DB      │
│      │                      │                    │      │
│      │ PushSubscription     │                    │      │
│      │ + keywords[]         │                    │      │
│      │─────────────────────>│                    │      │
│      │                      │                    │      │
│      │                      │ INSERT INTO        │      │
│      │                      │ PushSubscription   │      │
│      │                      │───────────────────>│      │
│      │                      │                    │      │
│      │                      │ INSERT INTO        │      │
│      │                      │ UserKeyword (N개)  │      │
│      │                      │───────────────────>│      │
│      │                      │                    │      │
└─────────────────────────────────────────────────────────┘

2. RSS 수집 & 알림 전송
┌─────────────────────────────────────────────────────────┐
│                                                         │
│  GitHub       서버                    DB        Push    │
│  Actions        │                      │        Service │
│    │            │                      │           │    │
│    │ trigger    │                      │           │    │
│    │───────────>│                      │           │    │
│    │            │                      │           │    │
│    │            │ RSS 수집             │           │    │
│    │            │ (외부 RSS 피드)      │           │    │
│    │            │                      │           │    │
│    │            │ INSERT News          │           │    │
│    │            │─────────────────────>│           │    │
│    │            │                      │           │    │
│    │            │ SELECT 새 뉴스       │           │    │
│    │            │<─────────────────────│           │    │
│    │            │                      │           │    │
│    │            │ SELECT 활성 구독     │           │    │
│    │            │ + 키워드             │           │    │
│    │            │<─────────────────────│           │    │
│    │            │                      │           │    │
│    │            │ 키워드 매칭          │           │    │
│    │            │ (뉴스 제목/요약 ∩    │           │    │
│    │            │  사용자 키워드)      │           │    │
│    │            │                      │           │    │
│    │            │ web-push 전송        │           │    │
│    │            │─────────────────────────────────>│    │
│    │            │                      │           │    │
│    │            │ INSERT               │           │    │
│    │            │ NotificationLog      │           │    │
│    │            │─────────────────────>│           │    │
│    │            │                      │           │    │
│    │            │ UPDATE News          │           │    │
│    │            │ notificationSent=true│           │    │
│    │            │─────────────────────>│           │    │
│    │            │                      │           │    │
└─────────────────────────────────────────────────────────┘

3. 키워드 동기화
┌─────────────────────────────────────────────────────────┐
│                                                         │
│  localStorage     클라이언트     서버           DB      │
│      │                │           │              │      │
│      │ 키워드 추가    │           │              │      │
│      │<───────────────│           │              │      │
│      │                │           │              │      │
│      │                │ POST      │              │      │
│      │                │ /api/push/keywords       │      │
│      │                │──────────>│              │      │
│      │                │           │              │      │
│      │                │           │ DELETE WHERE │      │
│      │                │           │ subscriptionId      │
│      │                │           │─────────────>│      │
│      │                │           │              │      │
│      │                │           │ INSERT       │      │
│      │                │           │ UserKeyword[]│      │
│      │                │           │─────────────>│      │
│      │                │           │              │      │
└─────────────────────────────────────────────────────────┘
```

---

## 5. 알림 전송 아키텍처

### 5.1 키워드 매칭 엔진

```
┌─────────────────────────────────────────────────────────────────┐
│                    키워드 매칭 알고리즘                          │
│                                                                 │
│  입력:                                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  새로 수집된 뉴스 목록 (N개)                             │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │ News #1: "삼성전자, AI 반도체 신제품 발표"       │    │   │
│  │  │ News #2: "현대차, 전기차 판매량 급증"            │    │   │
│  │  │ News #3: "카카오, AI 챗봇 서비스 출시"           │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  │                                                         │   │
│  │  활성 구독 목록 (M개)                                   │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │ 구독 A: keywords = ["AI", "반도체"]              │    │   │
│  │  │ 구독 B: keywords = ["전기차", "현대"]            │    │   │
│  │  │ 구독 C: keywords = ["카카오", "네이버"]          │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  처리 단계:                                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  1단계: 역인덱스 생성 (O(M*K), K=평균 키워드 수)        │   │
│  │                                                         │   │
│  │  keywordToSubscriptions = Map {                         │   │
│  │    "ai"     → [구독 A],                                 │   │
│  │    "반도체" → [구독 A],                                 │   │
│  │    "전기차" → [구독 B],                                 │   │
│  │    "현대"   → [구독 B],                                 │   │
│  │    "카카오" → [구독 C],                                 │   │
│  │    "네이버" → [구독 C]                                  │   │
│  │  }                                                      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  2단계: 뉴스별 키워드 매칭 (O(N*W), W=평균 단어 수)     │   │
│  │                                                         │   │
│  │  for each news in newsList:                             │   │
│  │    textLower = (title + summary).toLowerCase()          │   │
│  │                                                         │   │
│  │    for each keyword in keywordToSubscriptions.keys():   │   │
│  │      if textLower.includes(keyword):                    │   │
│  │        matchedSubscriptions.add(                        │   │
│  │          keywordToSubscriptions.get(keyword)            │   │
│  │        )                                                │   │
│  │                                                         │   │
│  │  결과:                                                  │   │
│  │  News #1 → [구독 A] (AI, 반도체 매칭)                   │   │
│  │  News #2 → [구독 B] (전기차, 현대 매칭)                 │   │
│  │  News #3 → [구독 A, 구독 C] (AI, 카카오 매칭)           │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  3단계: 중복 제거 & 알림 큐 생성                        │   │
│  │                                                         │   │
│  │  notificationQueue = [                                  │   │
│  │    { subscription: A, news: #1, keyword: "AI" },        │   │
│  │    { subscription: B, news: #2, keyword: "전기차" },    │   │
│  │    { subscription: A, news: #3, keyword: "AI" },        │   │
│  │    { subscription: C, news: #3, keyword: "카카오" }     │   │
│  │  ]                                                      │   │
│  │                                                         │   │
│  │  중복 제거 (같은 구독자에게 같은 뉴스 1회만):           │   │
│  │  Set<subscriptionId + newsId>                           │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  출력:                                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  구독 A → 알림 2개 (News #1, #3)                        │   │
│  │  구독 B → 알림 1개 (News #2)                            │   │
│  │  구독 C → 알림 1개 (News #3)                            │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 Web Push 프로토콜

```
┌─────────────────────────────────────────────────────────────────┐
│                    Web Push 전송 흐름                           │
│                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────────┐ │
│  │   서버      │    │ Push Service│    │  사용자 브라우저    │ │
│  │ (Next.js)   │    │ (FCM/APNs)  │    │  (Service Worker)   │ │
│  └──────┬──────┘    └──────┬──────┘    └──────────┬──────────┘ │
│         │                  │                      │             │
│         │                  │                      │             │
│  1. 알림 전송 요청         │                      │             │
│  ┌──────┴──────────────────┴──────────────────────┴──────┐     │
│  │                                                        │     │
│  │  webpush.sendNotification(                             │     │
│  │    subscription: {                                     │     │
│  │      endpoint: "https://fcm.googleapis.com/fcm/...",   │     │
│  │      keys: {                                           │     │
│  │        p256dh: "BNcRdreALRF...",  // 공개키            │     │
│  │        auth: "tBHItJI5sv..."      // 인증 시크릿       │     │
│  │      }                                                 │     │
│  │    },                                                  │     │
│  │    payload: JSON.stringify({                           │     │
│  │      title: "[AI] 연합뉴스",                           │     │
│  │      body: "삼성전자, AI 반도체 신제품 발표",          │     │
│  │      url: "https://...",                               │     │
│  │      ...                                               │     │
│  │    }),                                                 │     │
│  │    options: {                                          │     │
│  │      TTL: 86400,           // 24시간 유효              │     │
│  │      vapidDetails: {                                   │     │
│  │        subject: "mailto:admin@...",                    │     │
│  │        publicKey: VAPID_PUBLIC_KEY,                    │     │
│  │        privateKey: VAPID_PRIVATE_KEY                   │     │
│  │      }                                                 │     │
│  │    }                                                   │     │
│  │  )                                                     │     │
│  │                                                        │     │
│  └────────────────────────────────────────────────────────┘     │
│         │                                                       │
│         │ HTTP POST (암호화된 페이로드)                         │
│         │ Authorization: vapid t=..., k=...                     │
│         │ Content-Encoding: aes128gcm                          │
│         │                                                       │
│         ▼                                                       │
│  ┌──────────────────────────────────────────────────────┐      │
│  │                   Push Service                        │      │
│  │                                                       │      │
│  │  • endpoint URL로 요청 수신                          │      │
│  │  • VAPID 서명 검증                                   │      │
│  │  • 구독 유효성 확인                                  │      │
│  │  • 메시지 큐에 저장                                  │      │
│  │                                                       │      │
│  │  응답:                                                │      │
│  │  • 201 Created: 성공                                 │      │
│  │  • 410 Gone: 구독 만료 (삭제 필요)                   │      │
│  │  • 429 Too Many: 속도 제한                           │      │
│  └──────────────────────────────────────────────────────┘      │
│         │                                                       │
│         │ 디바이스가 온라인일 때 전달                           │
│         ▼                                                       │
│  ┌──────────────────────────────────────────────────────┐      │
│  │              사용자 디바이스 (Service Worker)         │      │
│  │                                                       │      │
│  │  self.addEventListener('push', (event) => {          │      │
│  │    const data = event.data.json()                    │      │
│  │                                                       │      │
│  │    // p256dh 키로 복호화 (브라우저가 자동 처리)      │      │
│  │                                                       │      │
│  │    self.registration.showNotification(               │      │
│  │      data.title,                                     │      │
│  │      {                                                │      │
│  │        body: data.body,                              │      │
│  │        icon: '/icons/icon-192x192.png',              │      │
│  │        ...                                            │      │
│  │      }                                                │      │
│  │    )                                                  │      │
│  │  })                                                   │      │
│  └──────────────────────────────────────────────────────┘      │
│         │                                                       │
│         ▼                                                       │
│  ┌──────────────────────────────────────────────────────┐      │
│  │                    시스템 알림                        │      │
│  │  ┌────────────────────────────────────────────────┐  │      │
│  │  │  📰 키워드뉴스                              ×  │  │      │
│  │  │                                                │  │      │
│  │  │  [AI] 연합뉴스                                │  │      │
│  │  │  삼성전자, AI 반도체 신제품 발표              │  │      │
│  │  │                                                │  │      │
│  │  │  [열기]  [닫기]                               │  │      │
│  │  └────────────────────────────────────────────────┘  │      │
│  └──────────────────────────────────────────────────────┘      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. 보안 아키텍처

### 6.1 인증 및 암호화

```
┌─────────────────────────────────────────────────────────────────┐
│                       보안 레이어                                │
│                                                                 │
│  1. VAPID (Voluntary Application Server Identification)        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                         │   │
│  │  목적: 서버 신원 확인 (Push Service가 요청 출처 검증)   │   │
│  │                                                         │   │
│  │  ┌─────────────┐         ┌─────────────┐               │   │
│  │  │ Public Key  │         │ Private Key │               │   │
│  │  │ (공개)      │         │ (비밀)      │               │   │
│  │  │             │         │             │               │   │
│  │  │ • 클라이언트│         │ • 서버만    │               │   │
│  │  │   구독 시   │         │   보관      │               │   │
│  │  │   사용      │         │             │               │   │
│  │  │             │         │ • 요청 서명 │               │   │
│  │  │ • Push      │         │   에 사용   │               │   │
│  │  │   Service에 │         │             │               │   │
│  │  │   전달됨    │         │             │               │   │
│  │  └─────────────┘         └─────────────┘               │   │
│  │                                                         │   │
│  │  서명 생성: JWT (ES256 알고리즘)                        │   │
│  │  Authorization: vapid t=<JWT>, k=<Public Key>           │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  2. 페이로드 암호화 (End-to-End Encryption)                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                         │   │
│  │  ┌─────────────────────────────────────────────────┐   │   │
│  │  │                   구독 생성 시                   │   │   │
│  │  │                                                 │   │   │
│  │  │  브라우저가 키 쌍 생성:                         │   │   │
│  │  │  • p256dh: ECDH 공개키 (서버에 전달)            │   │   │
│  │  │  • 개인키: 브라우저만 보관                      │   │   │
│  │  │                                                 │   │   │
│  │  │  auth: 16바이트 랜덤 시크릿 (서버에 전달)       │   │   │
│  │  └─────────────────────────────────────────────────┘   │   │
│  │                         │                               │   │
│  │                         ▼                               │   │
│  │  ┌─────────────────────────────────────────────────┐   │   │
│  │  │                   알림 전송 시                   │   │   │
│  │  │                                                 │   │   │
│  │  │  서버:                                          │   │   │
│  │  │  1. 임시 ECDH 키 쌍 생성                        │   │   │
│  │  │  2. p256dh와 ECDH 키 교환 → 공유 비밀 생성      │   │   │
│  │  │  3. auth + 공유 비밀 → 암호화 키 유도           │   │   │
│  │  │  4. AES-128-GCM으로 페이로드 암호화             │   │   │
│  │  │                                                 │   │   │
│  │  │  Content-Encoding: aes128gcm                    │   │   │
│  │  └─────────────────────────────────────────────────┘   │   │
│  │                         │                               │   │
│  │                         ▼                               │   │
│  │  ┌─────────────────────────────────────────────────┐   │   │
│  │  │                   수신 시                        │   │   │
│  │  │                                                 │   │   │
│  │  │  브라우저:                                       │   │   │
│  │  │  1. 서버의 임시 공개키 추출                     │   │   │
│  │  │  2. 개인키로 ECDH 키 교환 → 공유 비밀 생성      │   │   │
│  │  │  3. 복호화 키 유도                              │   │   │
│  │  │  4. AES-128-GCM으로 페이로드 복호화             │   │   │
│  │  │                                                 │   │   │
│  │  │  ※ Push Service는 암호화된 데이터만 중계       │   │   │
│  │  │     (내용 열람 불가)                            │   │   │
│  │  └─────────────────────────────────────────────────┘   │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  3. API 인증                                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                         │   │
│  │  /api/rss/collect (RSS 수집)                            │   │
│  │  /api/push/send (알림 전송)                             │   │
│  │  ─────────────────────────────                          │   │
│  │  x-cron-secret: CRON_SECRET 헤더로 인증                 │   │
│  │                                                         │   │
│  │  if (request.headers.get('x-cron-secret') !==           │   │
│  │      process.env.CRON_SECRET) {                         │   │
│  │    return 401 Unauthorized                              │   │
│  │  }                                                      │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. 에러 처리 및 복구

### 7.1 에러 시나리오 및 처리

```
┌─────────────────────────────────────────────────────────────────┐
│                    에러 처리 전략                                │
│                                                                 │
│  1. 구독 만료 (410 Gone)                                        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                         │   │
│  │  원인:                                                  │   │
│  │  • 사용자가 브라우저에서 알림 차단                      │   │
│  │  • 앱 삭제                                              │   │
│  │  • 오랜 기간 미사용                                     │   │
│  │                                                         │   │
│  │  처리:                                                  │   │
│  │  try {                                                  │   │
│  │    await webpush.sendNotification(...)                  │   │
│  │  } catch (error) {                                      │   │
│  │    if (error.statusCode === 410) {                      │   │
│  │      // 구독 비활성화                                   │   │
│  │      await prisma.pushSubscription.update({             │   │
│  │        where: { id: subscriptionId },                   │   │
│  │        data: { isActive: false }                        │   │
│  │      })                                                 │   │
│  │    }                                                    │   │
│  │  }                                                      │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  2. 속도 제한 (429 Too Many Requests)                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                         │   │
│  │  원인:                                                  │   │
│  │  • 단시간 너무 많은 알림 전송                           │   │
│  │                                                         │   │
│  │  처리:                                                  │   │
│  │  • Retry-After 헤더 확인                                │   │
│  │  • 지수 백오프 (exponential backoff)                    │   │
│  │  • 알림 배치 처리                                       │   │
│  │                                                         │   │
│  │  async function sendWithRetry(sub, payload, retries=3) {│   │
│  │    for (let i = 0; i < retries; i++) {                  │   │
│  │      try {                                              │   │
│  │        return await webpush.sendNotification(...)       │   │
│  │      } catch (error) {                                  │   │
│  │        if (error.statusCode === 429) {                  │   │
│  │          const delay = Math.pow(2, i) * 1000           │   │
│  │          await sleep(delay)                             │   │
│  │          continue                                       │   │
│  │        }                                                │   │
│  │        throw error                                      │   │
│  │      }                                                  │   │
│  │    }                                                    │   │
│  │  }                                                      │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  3. 네트워크 오류                                               │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                         │   │
│  │  원인:                                                  │   │
│  │  • Push Service 일시 장애                               │   │
│  │  • DNS 실패                                             │   │
│  │  • 타임아웃                                             │   │
│  │                                                         │   │
│  │  처리:                                                  │   │
│  │  • 로그 기록                                            │   │
│  │  • NotificationLog에 status='failed' 저장               │   │
│  │  • 다음 수집 주기에 재시도 (notificationSent=false)     │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  4. 구독 데이터 불일치                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                         │   │
│  │  원인:                                                  │   │
│  │  • localStorage와 서버 키워드 불일치                    │   │
│  │                                                         │   │
│  │  처리:                                                  │   │
│  │  • 키워드 변경 시 자동 동기화                           │   │
│  │  • useEffect로 마운트 시 동기화 확인                    │   │
│  │  • 수동 동기화 버튼 제공                                │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 8. 성능 고려사항

### 8.1 최적화 전략

```
┌─────────────────────────────────────────────────────────────────┐
│                       성능 최적화                                │
│                                                                 │
│  1. 키워드 매칭 최적화                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                         │   │
│  │  문제: N개 뉴스 × M개 구독 × K개 키워드 = O(N*M*K)      │   │
│  │                                                         │   │
│  │  해결: 역인덱스 사용                                    │   │
│  │                                                         │   │
│  │  // 비효율적 (O(N*M*K))                                 │   │
│  │  for (news of newsList) {                               │   │
│  │    for (sub of subscriptions) {                         │   │
│  │      for (keyword of sub.keywords) {                    │   │
│  │        if (news.title.includes(keyword)) ...            │   │
│  │      }                                                  │   │
│  │    }                                                    │   │
│  │  }                                                      │   │
│  │                                                         │   │
│  │  // 효율적 (O(N*K + M*K))                               │   │
│  │  // 1. 역인덱스 생성 (1회)                              │   │
│  │  keywordMap = buildKeywordIndex(subscriptions) // O(M*K)│   │
│  │                                                         │   │
│  │  // 2. 뉴스별 매칭                                      │   │
│  │  for (news of newsList) {                               │   │
│  │    for (keyword of keywordMap.keys()) {     // O(N*K)   │   │
│  │      if (news.title.includes(keyword)) {                │   │
│  │        matchedSubs.push(...keywordMap.get(keyword))     │   │
│  │      }                                                  │   │
│  │    }                                                    │   │
│  │  }                                                      │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  2. 배치 처리                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                         │   │
│  │  // 알림 개별 전송 (느림)                               │   │
│  │  for (notification of queue) {                          │   │
│  │    await sendNotification(notification)  // 순차 실행   │   │
│  │  }                                                      │   │
│  │                                                         │   │
│  │  // 병렬 배치 전송 (빠름)                               │   │
│  │  const batchSize = 10                                   │   │
│  │  for (let i = 0; i < queue.length; i += batchSize) {    │   │
│  │    const batch = queue.slice(i, i + batchSize)          │   │
│  │    await Promise.all(                                   │   │
│  │      batch.map(n => sendNotification(n))                │   │
│  │    )                                                    │   │
│  │  }                                                      │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  3. DB 쿼리 최적화                                              │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                         │   │
│  │  // 비효율적 (N+1 문제)                                 │   │
│  │  const subs = await prisma.pushSubscription.findMany()  │   │
│  │  for (sub of subs) {                                    │   │
│  │    const keywords = await prisma.userKeyword.findMany({ │   │
│  │      where: { subscriptionId: sub.id }                  │   │
│  │    })                                                   │   │
│  │  }                                                      │   │
│  │                                                         │   │
│  │  // 효율적 (JOIN)                                       │   │
│  │  const subs = await prisma.pushSubscription.findMany({  │   │
│  │    where: { isActive: true },                           │   │
│  │    include: {                                           │   │
│  │      keywords: {                                        │   │
│  │        where: { isEnabled: true }                       │   │
│  │      }                                                  │   │
│  │    }                                                    │   │
│  │  })                                                     │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  4. 알림 그룹화 (배터리 절약)                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                         │   │
│  │  // 같은 구독자에게 여러 뉴스 → 1개 알림으로 통합       │   │
│  │                                                         │   │
│  │  if (matchedNews.length > 3) {                          │   │
│  │    // 개별 알림 대신 요약 알림                          │   │
│  │    notification = {                                     │   │
│  │      title: "키워드 뉴스 5건",                          │   │
│  │      body: "AI, 반도체 관련 새 뉴스가 도착했습니다",    │   │
│  │      tag: "keyword-news-batch"  // 같은 태그 = 덮어쓰기 │   │
│  │    }                                                    │   │
│  │  }                                                      │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 9. 모니터링 및 분석

### 9.1 메트릭 수집

```
NotificationLog 테이블 기반 분석:

1. 전송 통계
┌─────────────────────────────────────────────────────────┐
│                                                         │
│  SELECT                                                 │
│    DATE(createdAt) as date,                             │
│    status,                                              │
│    COUNT(*) as count                                    │
│  FROM NotificationLog                                   │
│  GROUP BY DATE(createdAt), status                       │
│                                                         │
│  결과:                                                  │
│  ┌──────────┬────────┬───────┐                          │
│  │ 날짜     │ 상태   │ 건수  │                          │
│  ├──────────┼────────┼───────┤                          │
│  │ 01-18    │ sent   │ 1,234 │                          │
│  │ 01-18    │ failed │   23  │                          │
│  │ 01-18    │ clicked│  456  │                          │
│  └──────────┴────────┴───────┘                          │
│                                                         │
└─────────────────────────────────────────────────────────┘

2. 인기 키워드
┌─────────────────────────────────────────────────────────┐
│                                                         │
│  SELECT                                                 │
│    keyword,                                             │
│    COUNT(*) as notification_count,                      │
│    SUM(CASE WHEN status='clicked' THEN 1 ELSE 0 END)    │
│      as click_count                                     │
│  FROM NotificationLog                                   │
│  WHERE keyword IS NOT NULL                              │
│  GROUP BY keyword                                       │
│  ORDER BY notification_count DESC                       │
│                                                         │
│  결과:                                                  │
│  ┌──────────┬────────┬────────┬─────────┐               │
│  │ 키워드   │ 전송   │ 클릭   │ CTR     │               │
│  ├──────────┼────────┼────────┼─────────┤               │
│  │ AI      │ 523    │ 89     │ 17.0%   │               │
│  │ 반도체  │ 312    │ 45     │ 14.4%   │               │
│  │ 전기차  │ 289    │ 52     │ 18.0%   │               │
│  └──────────┴────────┴────────┴─────────┘               │
│                                                         │
└─────────────────────────────────────────────────────────┘

3. 구독 상태
┌─────────────────────────────────────────────────────────┐
│                                                         │
│  SELECT                                                 │
│    isActive,                                            │
│    COUNT(*) as count                                    │
│  FROM PushSubscription                                  │
│  GROUP BY isActive                                      │
│                                                         │
│  결과:                                                  │
│  • 활성 구독: 1,234                                     │
│  • 비활성 구독: 567                                     │
│  • 활성률: 68.5%                                        │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 10. 구현 계획

### 10.1 Phase 구성

| Phase | 내용 | 파일 수 | 난이도 |
|-------|------|---------|--------|
| 1 | Service Worker + PWA 설정 | 3-4개 | 중 |
| 2 | DB 스키마 확장 | 1개 + 마이그레이션 | 하 |
| 3 | API 엔드포인트 | 4-5개 | 중 |
| 4 | RSS 수집 알림 로직 | 2-3개 | 중 |
| 5 | 클라이언트 UI | 3-4개 | 중 |

### 10.2 Phase 1: 기반 구축

**패키지 설치:**
```bash
npm install web-push
npm install -D serwist @serwist/next
```

**파일 구조:**
```
KeyWordsNews/
├── app/
│   └── sw.ts                    # Service Worker 소스
├── next.config.ts               # serwist 플러그인 설정
├── public/
│   └── sw.js                    # 빌드 후 생성
└── lib/
    └── push/
        ├── vapid.ts             # VAPID 키 관리
        ├── subscription.ts      # 구독 관리
        └── sender.ts            # 알림 전송
```

**VAPID 키 생성:**
```bash
npx web-push generate-vapid-keys
```

### 10.3 필요한 환경 변수

```env
# VAPID 키 (web-push)
NEXT_PUBLIC_VAPID_PUBLIC_KEY=BEl62iUYgUivxIkv69yViEuiBIa...
VAPID_PRIVATE_KEY=UUxI4O8-FbROU5_1c2Hmyr1Kk7cn...
VAPID_SUBJECT=mailto:admin@keywordsnews.com
```

### 10.4 고려사항

1. **iOS Safari 제한**: iOS 16.4+에서만 PWA 푸시 알림 지원
2. **알림 빈도 제한**: 스팸 방지를 위해 동일 키워드 알림 간격 설정 (예: 1시간)
3. **배터리 최적화**: 알림 그룹화로 배터리 소모 최소화
4. **오프라인 처리**: 오프라인 시 알림 큐잉

### 10.5 전체 흐름 요약

```
1. 사용자가 앱 첫 방문
   ↓
2. PushNotificationPrompt 표시 (하단 배너)
   ↓
3. "알림 받기" 클릭
   ↓
4. 브라우저 권한 요청 팝업
   ↓
5. 허용 시:
   - Service Worker 등록
   - PushSubscription 생성
   - 서버에 구독 정보 + 키워드 전송
   ↓
6. 10분마다 RSS 수집 (GitHub Actions)
   ↓
7. 새 뉴스 수집 시:
   - 모든 활성 구독의 키워드 매칭
   - 매칭된 구독자에게 푸시 알림 전송
   ↓
8. 사용자 디바이스에 알림 표시
   ↓
9. 알림 클릭 → 해당 뉴스 URL로 이동
```

---

## 문서 정보

- **작성일**: 2026-01-18
- **버전**: 1.0.0
- **프로젝트**: KeyWordsNews
- **관련 문서**: [CLAUDE.md](/CLAUDE.md)
