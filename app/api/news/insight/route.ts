import { NextRequest, NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'
import { scrapeNewsContent } from '@/lib/scraper/newsContent'
import { getExpert, type CategoryExpert } from '@/lib/ai/experts'
import {
  callGroqJSON,
  callGeminiJSON,
  callOpenRouterJSON,
  runWithFallback,
  AllProvidersFailedError,
} from '@/lib/ai/generate'

interface InsightResult {
  insight: string
  expert: string
  keywords?: string[]
}

// AI ì‘ë‹µì—ì„œ íŒŒì‹±ë˜ëŠ” JSON êµ¬ì¡° (expert í•„ë“œ ì—†ìŒ)
interface AIInsightResponse {
  insight: string
  keywords?: string[]
}

// Gemini ì‘ë‹µ ìŠ¤í‚¤ë§ˆ
const GEMINI_SCHEMA = {
  type: 'object',
  properties: {
    insight: {
      type: 'string',
      description: 'ì „ë¬¸ê°€ ë¶„ì„ í…ìŠ¤íŠ¸ (ë§ˆí¬ë‹¤ìš´ í˜•ì‹)',
    },
    keywords: {
      type: 'array',
      items: { type: 'string' },
      description: 'í•µì‹¬ í‚¤ì›Œë“œ 3-5ê°œ',
    },
  },
  required: ['insight', 'keywords'],
}

// â”€â”€ ì¹´í…Œê³ ë¦¬ë³„ ë¶„ì„ í”„ë ˆì„ì›Œí¬ â”€â”€

const CATEGORY_ANALYSIS_FRAMES: Record<string, {
  systemAddendum: string  // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ì— ì¶”ê°€í•  ë¶„ì„ í”„ë ˆì„ì›Œí¬
  sections: string        // ìœ ì € í”„ë¡¬í”„íŠ¸ì˜ ë¶„ì„ ìš”ì²­ ì„¹ì…˜
}> = {
  politics: {
    systemAddendum: `**ë‹¹ì‹ ì˜ ë¶„ì„ í”„ë ˆì„ì›Œí¬:**
- ì •ì±…ì˜ ìˆ˜í˜œìì™€ í”¼í•´ìë¥¼ êµ¬ë¶„í•˜ê³ , ì •ì¹˜ì  ì˜ë„ì™€ ì‹¤ì œ íš¨ê³¼ì˜ ì°¨ì´ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤
- ì—¬ì•¼ ì—­í•™, êµ­ë¯¼ ì—¬ë¡ , í—Œë²•ì  í•¨ì˜ë¥¼ ê³ ë ¤í•œ ë‹¤ì¸µì  ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤
- ì°¬ë°˜ ì–‘ì¸¡ì˜ ë…¼ë¦¬ë¥¼ ê· í˜• ìˆê²Œ ì†Œê°œí•˜ë˜, ì‚¬ì‹¤ê´€ê³„ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í‰ê°€í•©ë‹ˆë‹¤`,
    sections: `1. **ğŸ“Œ ì´í•´ê´€ê³„ êµ¬ë„** (2-3ì¤„)
   - ì´ ë‰´ìŠ¤ì˜ ë°°ê²½ê³¼ ë§¥ë½
   - ì£¼ìš” ì´í•´ê´€ê³„ì(ì—¬ë‹¹/ì•¼ë‹¹/ì‹œë¯¼ë‹¨ì²´/ê´€ë ¨ ë¶€ì²˜ ë“±)ì˜ ì…ì¥

2. **ğŸ“Š ì •ì¹˜ì  ì˜ë¯¸ + ì‚¬íšŒì  ì˜í–¥** (3-4ì¤„)
   - ì´ ë‰´ìŠ¤ê°€ ì •ì¹˜ ì§€í˜•ì— ë¯¸ì¹˜ëŠ” ì˜í–¥
   - ì¼ë°˜ì¸ì´ ë†“ì¹˜ê¸° ì‰¬ìš´ ì •ì¹˜ì  ë§¥ë½ (ì„ ê±°, ë‹¹ë‚´ ì—­í•™, ì™¸êµ ë“±)
   - ì°¬ë°˜ ì–‘ì¸¡ì˜ í•µì‹¬ ë…¼ë¦¬

3. **âš¡ êµ­ë¯¼ì—ê²Œ ë¯¸ì¹˜ëŠ” ì˜í–¥** (2-3ì¤„)
   - ì´ ì •ì±…/ì‚¬ê±´ì´ ì‹œë¯¼ ìƒí™œì— ë¯¸ì¹˜ëŠ” ì‹¤ì§ˆì  ë³€í™”
   - êµ¬ì²´ì  ìˆ˜ì¹˜ì™€ ëŒ€ìƒ ë²”ìœ„

4. **ğŸ”® ë‹¤ìŒ ì˜ˆìƒ ìˆ˜ìˆœ** (1-2ì¤„)
   - í›„ì† ì…ë²•/ì •ì±…/ì •ì¹˜ì  í–‰ë³´ ì˜ˆì¸¡
   - "ì´ ë‰´ìŠ¤ë¥¼ ë³´ê³  ì£¼ëª©í•´ì•¼ í•  í›„ì† ì „ê°œ"`,
  },

  economy: {
    systemAddendum: `**ë‹¹ì‹ ì˜ ë¶„ì„ í”„ë ˆì„ì›Œí¬:**
- ê±°ì‹œê²½ì œ ì§€í‘œì™€ì˜ ì—°ê´€ì„±, ì‚°ì—… ë°¸ë¥˜ì²´ì¸ ì˜í–¥, íˆ¬ìì ê´€ì ì˜ ì‹œì‚¬ì ì„ ë¶„ì„í•©ë‹ˆë‹¤
- ìœ ì‚¬í•œ ê³¼ê±° ì‚¬ë¡€ì™€ ë¹„êµí•˜ì—¬ í˜„ì¬ ìƒí™©ì˜ ì˜ë¯¸ë¥¼ í•´ì„í•©ë‹ˆë‹¤
- êµ¬ì²´ì ì¸ ìˆ˜ì¹˜ë¥¼ ê·¼ê±°ë¡œ ë¶„ì„í•˜ë©°, ë‚™ê´€/ë¹„ê´€ ì–‘ë©´ì˜ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì œì‹œí•©ë‹ˆë‹¤`,
    sections: `1. **ğŸ“Œ ì‹œì¥ ë§¥ë½** (2-3ì¤„)
   - ê´€ë ¨ ê²½ì œ ì§€í‘œ/ë°ì´í„°ì™€ ì—°ê²°
   - ì´ ë‰´ìŠ¤ê°€ ë‚˜ì˜¨ ê±°ì‹œê²½ì œì  ë°°ê²½

2. **ğŸ“Š ì‚°ì—…/ì‹œì¥ ì˜í–¥ ë¶„ì„** (3-4ì¤„)
   - ê´€ë ¨ ì‚°ì—…ê³¼ ê¸°ì—…ì— ë¯¸ì¹˜ëŠ” ì˜í–¥
   - ê³¼ê±° ìœ ì‚¬ ì‚¬ë¡€ì™€ ë¹„êµ
   - ë‹¨ê¸°/ì¤‘ì¥ê¸° íŒŒê¸‰ íš¨ê³¼

3. **âš¡ íˆ¬ì ì‹œì‚¬ì ** (2-3ì¤„)
   - íˆ¬ìì/ì†Œë¹„ìê°€ ì£¼ëª©í•´ì•¼ í•  í•µì‹¬ í¬ì¸íŠ¸
   - ê´€ë ¨ ìˆ˜í˜œ/í”¼í•´ ì—…ì¢…ì´ë‚˜ ë¶„ì•¼

4. **ğŸ”® ì‹œë‚˜ë¦¬ì˜¤ë³„ ì „ë§** (1-2ì¤„)
   - ë‚™ê´€ì /ë¹„ê´€ì  ì‹œë‚˜ë¦¬ì˜¤ì˜ í•µì‹¬ í¬ì¸íŠ¸`,
  },

  tech: {
    systemAddendum: `**ë‹¹ì‹ ì˜ ë¶„ì„ í”„ë ˆì„ì›Œí¬:**
- ê¸°ìˆ  ì„±ìˆ™ë„, ì‹œì¥ íŒŒê´´ë ¥, ê¸°ì¡´ ê¸°ìˆ  ëŒ€ë¹„ ì°¨ë³„ì ì„ ë¶„ì„í•©ë‹ˆë‹¤
- ê¸°ìˆ ì˜ ì‚¬íšŒì  ì˜í–¥ê³¼ ìœ¤ë¦¬ì  ìŸì ê¹Œì§€ ê³ ë ¤í•©ë‹ˆë‹¤
- ì—…ê³„ ê²½ìŸ êµ¬ë„ì™€ ìƒíƒœê³„ ë³€í™”ë¥¼ í•¨ê»˜ ë¶„ì„í•©ë‹ˆë‹¤`,
    sections: `1. **ğŸ“Œ ê¸°ìˆ  ë°°ê²½** (2-3ì¤„)
   - ê¸°ì¡´ ê¸°ìˆ ê³¼ì˜ ì°¨ì´ì , ê¸°ìˆ  ì„±ìˆ™ë„
   - ì´ ê¸°ìˆ /ì œí’ˆì´ ë“±ì¥í•œ ì‹œì¥ ë§¥ë½

2. **ğŸ“Š ê¸°ìˆ ì  ì˜ë¯¸ + ì‹œì¥ ì˜í–¥** (3-4ì¤„)
   - í˜ì‹ ì˜ í•µì‹¬ê³¼ ê¸°ìˆ ì  ì˜ì˜
   - ê´€ë ¨ ê¸°ì—…/ê¸°ê´€ê³¼ ê²½ìŸ êµ¬ë„
   - ì‚°ì—… ìƒíƒœê³„ì— ë¯¸ì¹˜ëŠ” íŒŒê¸‰ íš¨ê³¼

3. **âš¡ ì‹¤ìƒí™œ ë³€í™”** (2-3ì¤„)
   - ì´ ê¸°ìˆ ì´ ì¼ë°˜ ì‚¬ìš©ìì—ê²Œ ë¯¸ì¹  ë³€í™”
   - ê¸°ëŒ€ íš¨ê³¼ì™€ ìš°ë ¤ë˜ëŠ” ì  (ìœ¤ë¦¬, í”„ë¼ì´ë²„ì‹œ ë“±)

4. **ğŸ”® ê¸°ìˆ  ë°œì „ ë¡œë“œë§µ** (1-2ì¤„)
   - í–¥í›„ ê¸°ìˆ  ì§„í™” ë°©í–¥ê³¼ ìƒìš©í™” ì‹œì  ì˜ˆì¸¡`,
  },

  society: {
    systemAddendum: `**ë‹¹ì‹ ì˜ ë¶„ì„ í”„ë ˆì„ì›Œí¬:**
- ì‚¬ê±´ì˜ êµ¬ì¡°ì  ì›ì¸ê³¼ ì‹œìŠ¤í…œì  ë¬¸ì œë¥¼ íŒŒì•…í•©ë‹ˆë‹¤
- ì˜í–¥ë°›ëŠ” ì‚¬ëŒë“¤ì˜ ê´€ì ì—ì„œ ë¶„ì„í•˜ë©°, ì‚¬íšŒì  ì•½ìì˜ ëª©ì†Œë¦¬ë¥¼ ê³ ë ¤í•©ë‹ˆë‹¤
- ì œë„ì  ê°œì„  ë°©í–¥ê³¼ ì‹œë¯¼ í–‰ë™ ê°€ëŠ¥ì„±ì„ ì œì‹œí•©ë‹ˆë‹¤`,
    sections: `1. **ğŸ“Œ ì‚¬ê±´ ë°°ê²½ê³¼ êµ¬ì¡°ì  ì›ì¸** (2-3ì¤„)
   - ì´ ì‚¬ê±´/ì´ìŠˆì˜ ê²½ìœ„ì™€ ë°°ê²½
   - ê·¼ë³¸ì ì¸ êµ¬ì¡°ì /ì œë„ì  ì›ì¸

2. **ğŸ“Š ì‚¬íšŒì  ì˜í–¥ ë¶„ì„** (3-4ì¤„)
   - ì˜í–¥ë°›ëŠ” ì‚¬ëŒë“¤ì˜ ê·œëª¨ì™€ ë²”ìœ„
   - ì„¸ëŒ€/ê³„ì¸µ/ì§€ì—­ë³„ ì°¨ë³„ì  ì˜í–¥
   - ìœ ì‚¬ ì‚¬ë¡€ì™€ì˜ ë¹„êµ

3. **âš¡ ì‹œë¯¼ ìƒí™œì— ë¯¸ì¹˜ëŠ” ì˜í–¥** (2-3ì¤„)
   - ì¼ë°˜ ì‹œë¯¼ì´ ì²´ê°í•  ë³€í™”
   - ì•Œì•„ë‘ë©´ ìœ ìš©í•œ ì œë„/ì§€ì› ì •ë³´

4. **ğŸ”® í–¥í›„ ì „ê°œ ë°©í–¥** (1-2ì¤„)
   - ì œë„ì  ê°œì„  ê°€ëŠ¥ì„±ê³¼ ì‚¬íšŒì  ë…¼ì˜ ë°©í–¥`,
  },

  world: {
    systemAddendum: `**ë‹¹ì‹ ì˜ ë¶„ì„ í”„ë ˆì„ì›Œí¬:**
- ê´€ë ¨ êµ­ê°€/ê¸°ê´€ì˜ ì´í•´ê´€ê³„ì™€ ì§€ì •í•™ì  ë§¥ë½ì„ ë¶„ì„í•©ë‹ˆë‹¤
- êµ­ì œ ì •ì„¸ì˜ í° ê·¸ë¦¼ ì†ì—ì„œ ì´ ë‰´ìŠ¤ì˜ ìœ„ì¹˜ë¥¼ íŒŒì•…í•©ë‹ˆë‹¤
- í•œêµ­ì— ë¯¸ì¹˜ëŠ” ì§ê°„ì ‘ì  ì˜í–¥ì„ ë°˜ë“œì‹œ í¬í•¨í•©ë‹ˆë‹¤`,
    sections: `1. **ğŸ“Œ êµ­ì œ ì •ì„¸ ë§¥ë½** (2-3ì¤„)
   - ê´€ë ¨ êµ­ê°€/ê¸°ê´€ì˜ ì…ì¥ê³¼ ì´í•´ê´€ê³„
   - ì§€ì •í•™ì  ë°°ê²½ (ë™ë§¹, ê°ˆë“±, ë¬´ì—­ ë“±)

2. **ğŸ“Š êµ­ì œ ì—­í•™ ë¶„ì„** (3-4ì¤„)
   - ê¸€ë¡œë²Œ íŒŒì›Œ ë°¸ëŸ°ìŠ¤ì— ë¯¸ì¹˜ëŠ” ì˜í–¥
   - ì£¼ìš”êµ­ì˜ ë°˜ì‘ê³¼ ëŒ€ì‘ ì „ëµ
   - ì—­ì‚¬ì  ìœ ì‚¬ ì‚¬ë¡€ì™€ ë¹„êµ

3. **âš¡ í•œêµ­ì— ë¯¸ì¹˜ëŠ” ì˜í–¥** (2-3ì¤„)
   - ì™¸êµ/ì•ˆë³´/ê²½ì œì  ì˜í–¥
   - í•œêµ­ ê¸°ì—…ê³¼ êµ­ë¯¼ì—ê²Œ ë¯¸ì¹˜ëŠ” ì‹¤ì§ˆì  ë³€í™”

4. **ğŸ”® í–¥í›„ ì „ê°œ ì „ë§** (1-2ì¤„)
   - êµ­ì œ ì •ì„¸ì˜ ì˜ˆìƒ ì „ê°œ ë°©í–¥`,
  },

  crypto: {
    systemAddendum: `**ë‹¹ì‹ ì˜ ë¶„ì„ í”„ë ˆì„ì›Œí¬:**
- ì‹œì¥ ì‹¬ë¦¬ì™€ ê¸°ìˆ ì  ë¶„ì„ì„ ê²°í•©í•˜ì—¬ ê°€ê²© ë™í–¥ì„ í•´ì„í•©ë‹ˆë‹¤
- ê·œì œ í™˜ê²½ ë³€í™”ê°€ ì‹œì¥ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ ì¤‘ì  ë¶„ì„í•©ë‹ˆë‹¤
- íˆ¬ê¸°ì  ìš”ì†Œì™€ ê¸°ìˆ ì  í˜ì‹ ì„ êµ¬ë¶„í•˜ì—¬ ê· í˜• ì¡íŒ ì‹œê°ì„ ì œê³µí•©ë‹ˆë‹¤`,
    sections: `1. **ğŸ“Œ ì‹œì¥ ë§¥ë½** (2-3ì¤„)
   - ê°€ê²©/ê±°ë˜ëŸ‰/ì‹œê°€ì´ì•¡ ë“± í•µì‹¬ ìˆ˜ì¹˜
   - ì´ ë‰´ìŠ¤ê°€ ë‚˜ì˜¨ ì‹œì¥ ìƒí™©

2. **ğŸ“Š ì‹œì¥ ì˜í–¥ ë¶„ì„** (3-4ì¤„)
   - ê°€ê²© ë³€ë™ ìš”ì¸ê³¼ ì‹œì¥ ì‹¬ë¦¬ ë¶„ì„
   - ê·œì œ/ì •ì±… ë³€í™”ì˜ ì˜í–¥
   - ê´€ë ¨ í”„ë¡œì íŠ¸/ê¸°ì—…ì˜ êµ¬ì²´ì  ë™í–¥

3. **âš¡ íˆ¬ìì ì£¼ëª© í¬ì¸íŠ¸** (2-3ì¤„)
   - ë¦¬ìŠ¤í¬ì™€ ê¸°íšŒ ìš”ì¸
   - ì£¼ì˜í•´ì•¼ í•  ì 

4. **ğŸ”® ì‹œì¥ ì „ë§** (1-2ì¤„)
   - ë‹¨ê¸°/ì¤‘ì¥ê¸° ì‹œì¥ ë°©í–¥ì„± ì˜ˆì¸¡`,
  },

  sports: {
    systemAddendum: `**ë‹¹ì‹ ì˜ ë¶„ì„ í”„ë ˆì„ì›Œí¬:**
- ê²½ê¸°ë ¥ê³¼ ì „ìˆ ì„ ì „ë¬¸ì ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤
- ì„ ìˆ˜/íŒ€ì˜ ì‹œì¦Œ ë§¥ë½ì—ì„œ ì´ ë‰´ìŠ¤ì˜ ì˜ë¯¸ë¥¼ í‰ê°€í•©ë‹ˆë‹¤
- ìŠ¤í¬ì¸  ì‚°ì—…ê³¼ íŒ¬ ë¬¸í™”ì˜ ê´€ì ë„ í•¨ê»˜ ë‹¤ë£¹ë‹ˆë‹¤`,
    sections: `1. **ğŸ“Œ ë°°ê²½/ë§¥ë½** (2-3ì¤„)
   - ê²½ê¸°/ì‚¬ê±´ì˜ ë°°ê²½ê³¼ ì‹œì¦Œ ë§¥ë½
   - ê´€ë ¨ ì„ ìˆ˜/íŒ€ì˜ ìµœê·¼ ì„±ì ê³¼ ìƒí™©

2. **ğŸ“Š ì „ë¬¸ê°€ ë¶„ì„** (3-4ì¤„)
   - ê²½ê¸°ë ¥/ì „ìˆ  ë¶„ì„ ë˜ëŠ” ì‚¬ê±´ì˜ í•µì‹¬ ì˜ë¯¸
   - ê¸°ë¡/ë°ì´í„° ê¸°ë°˜ì˜ ê°ê´€ì  í‰ê°€
   - íŒ€/ì„ ìˆ˜/ë¦¬ê·¸ì— ë¯¸ì¹˜ëŠ” ì˜í–¥

3. **âš¡ í•µì‹¬ ì‹œì‚¬ì ** (1-2ì¤„)
   - íŒ¬ì´ë‚˜ ê´€ê³„ìê°€ ì£¼ëª©í•´ì•¼ í•  í¬ì¸íŠ¸

4. **ğŸ”® í–¥í›„ ì „ë§** (1-2ì¤„)
   - ì‹œì¦Œ/ëŒ€íšŒ/ì»¤ë¦¬ì–´ ì¸¡ë©´ì˜ ì „ê°œ ì˜ˆì¸¡`,
  },

  entertainment: {
    systemAddendum: `**ë‹¹ì‹ ì˜ ë¶„ì„ í”„ë ˆì„ì›Œí¬:**
- ì½˜í…ì¸ ì˜ ì™„ì„±ë„ì™€ ì‹œì¥ ë°˜ì‘ì„ ì „ë¬¸ì ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤
- í•œë¥˜ íŠ¸ë Œë“œì™€ ê¸€ë¡œë²Œ ì—”í„°í…Œì¸ë¨¼íŠ¸ ì‹œì¥ì—ì„œì˜ ì˜ë¯¸ë¥¼ íŒŒì•…í•©ë‹ˆë‹¤
- ëŒ€ì¤‘ë¬¸í™”ì˜ ì‚¬íšŒì  ì˜í–¥ë ¥ë„ í•¨ê»˜ ë‹¤ë£¹ë‹ˆë‹¤`,
    sections: `1. **ğŸ“Œ ë°°ê²½/ë§¥ë½** (2-3ì¤„)
   - ì‘í’ˆ/í™œë™ì˜ ë°°ê²½ê³¼ ì—…ê³„ ë§¥ë½
   - ê´€ë ¨ ì•„í‹°ìŠ¤íŠ¸/ê¸°ì—…ì˜ ìµœê·¼ í™œë™

2. **ğŸ“Š ì „ë¬¸ê°€ ë¶„ì„** (3-4ì¤„)
   - ì½˜í…ì¸ /í™œë™ì˜ í•µì‹¬ ì˜ë¯¸ì™€ ì‹œì¥ ë°˜ì‘
   - ì„±ê³¼ ë°ì´í„° (ì‹œì²­ë¥ , í¥í–‰, ìŒì› ì°¨íŠ¸ ë“±)
   - ì—…ê³„ íŠ¸ë Œë“œì™€ì˜ ì—°ê´€ì„±

3. **âš¡ í•µì‹¬ ì‹œì‚¬ì ** (1-2ì¤„)
   - ì—…ê³„ ê´€ê³„ìë‚˜ íŒ¬ì´ ì£¼ëª©í•´ì•¼ í•  í¬ì¸íŠ¸

4. **ğŸ”® í–¥í›„ ì „ë§** (1-2ì¤„)
   - í›„ì† í™œë™/í”„ë¡œì íŠ¸ ì „ê°œ ì˜ˆì¸¡`,
  },

  culture: {
    systemAddendum: `**ë‹¹ì‹ ì˜ ë¶„ì„ í”„ë ˆì„ì›Œí¬:**
- ë¬¸í™”ì  ê°€ì¹˜ì™€ ì˜ˆìˆ ì  ì˜ë¯¸ë¥¼ ì‹¬ì¸µ ë¶„ì„í•©ë‹ˆë‹¤
- ì „í†µê³¼ í˜„ëŒ€ì˜ ì¡°í™”, ë¬¸í™” ë‹¤ì–‘ì„±ì˜ ê´€ì ì—ì„œ í‰ê°€í•©ë‹ˆë‹¤
- ë¬¸í™”ê°€ ì‚¬íšŒì— ë¯¸ì¹˜ëŠ” ì˜í–¥ê³¼ ë³´ì¡´ì˜ ì¤‘ìš”ì„±ì„ ê°•ì¡°í•©ë‹ˆë‹¤`,
    sections: `1. **ğŸ“Œ ë¬¸í™”ì  ë°°ê²½** (2-3ì¤„)
   - í–‰ì‚¬/ì‘í’ˆì˜ ë°°ê²½ê³¼ ë¬¸í™”ì  ë§¥ë½
   - ì—­ì‚¬ì  ì˜ë¯¸ë‚˜ ë¬¸í™”ì‚¬ì  ìœ„ì¹˜

2. **ğŸ“Š ì „ë¬¸ê°€ ë¶„ì„** (3-4ì¤„)
   - ë¬¸í™”ì /ì˜ˆìˆ ì  ì˜ì˜ì™€ ê°€ì¹˜ í‰ê°€
   - ì‚¬íšŒì  ì˜í–¥ê³¼ ì˜ë¯¸
   - ê´€ë ¨ ë¬¸í™” íŠ¸ë Œë“œì™€ì˜ ì—°ê´€ì„±

3. **âš¡ ì°¸ì—¬/ê´€ëŒ ì •ë³´** (1-2ì¤„)
   - ì¼ë°˜ì¸ì´ ì•Œë©´ ìœ ìš©í•œ ì •ë³´

4. **ğŸ”® í–¥í›„ ì „ë§** (1-2ì¤„)
   - ë¬¸í™” ë¶„ì•¼ì˜ ë°œì „ ë°©í–¥`,
  },
}

// ê¸°ë³¸ ë¶„ì„ ì„¹ì…˜ (ì¹´í…Œê³ ë¦¬ ë§¤ì¹­ ì•ˆ ë  ë•Œ)
const DEFAULT_SECTIONS = `1. **ğŸ“Œ ë°°ê²½/ë§¥ë½** (2-3ì¤„)
   - ì´ ë‰´ìŠ¤ê°€ ë‚˜ì˜¨ ë°°ê²½ê³¼ ë§¥ë½
   - ê´€ë ¨ ì´í•´ê´€ê³„ìì˜ ì…ì¥

2. **ğŸ“Š ì „ë¬¸ê°€ ë¶„ì„** (3-4ì¤„)
   - ì´ ë‰´ìŠ¤ì˜ í•µì‹¬ ì˜ë¯¸ì™€ ì˜í–¥
   - ì¼ë°˜ì¸ì´ ë†“ì¹˜ê¸° ì‰¬ìš´ ì¤‘ìš”í•œ ì 
   - ë‹¤ì–‘í•œ ê´€ì ì—ì„œì˜ í‰ê°€

3. **âš¡ í•µì‹¬ ì‹œì‚¬ì ** (2-3ì¤„)
   - ë…ìê°€ ë°˜ë“œì‹œ ì•Œì•„ì•¼ í•  í•µì‹¬ í¬ì¸íŠ¸
   - ì´ ë‰´ìŠ¤ê°€ ë‚˜ì—ê²Œ ì–´ë–¤ ì˜í–¥ì„ ì£¼ëŠ”ê°€

4. **ğŸ”® ì „ë§** (1-2ì¤„)
   - í–¥í›„ ì˜ˆìƒë˜ëŠ” ì „ê°œ ë°©í–¥`

// â”€â”€ í”„ë¡¬í”„íŠ¸ ìƒì„± â”€â”€

function buildInsightSystemPrompt(expert: CategoryExpert, category: string): string {
  const frame = CATEGORY_ANALYSIS_FRAMES[category]
  const frameworkText = frame?.systemAddendum || ''

  return `ë‹¹ì‹ ì€ **${expert.name}**ì…ë‹ˆë‹¤.

**ë‹¹ì‹ ì˜ ì „ë¬¸ì„±:**
${expert.expertise}

**ë‹¹ì‹ ì˜ ë¶„ì„ ê´€ì :**
${expert.perspective}
${frameworkText ? `\n${frameworkText}` : ''}
**ë¶„ì„ ì›ì¹™:**
- í•´ë‹¹ ë¶„ì•¼ì˜ ì „ë¬¸ ì§€ì‹ì„ ë°”íƒ•ìœ¼ë¡œ ê¹Šì´ ìˆëŠ” ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤
- í•œêµ­ì–´ë¡œ ì‘ì„±í•˜ë©°, ì˜ì–´ ì•½ì–´ëŠ” í•œê¸€ë¡œ í’€ì–´ì”ë‹ˆë‹¤ (ì˜ˆ: AIâ†’ì¸ê³µì§€ëŠ¥, GDPâ†’êµ­ë‚´ì´ìƒì‚°)
- ì¼ìƒì ìœ¼ë¡œ í†µìš©ë˜ëŠ” í•œìì–´ëŠ” ìì—°ìŠ¤ëŸ½ê²Œ ì‚¬ìš©í•©ë‹ˆë‹¤
- ì „ë¬¸ ìš©ì–´ëŠ” ê´„í˜¸ ì•ˆì— ì‰¬ìš´ ì„¤ëª…ì„ ë§ë¶™ì…ë‹ˆë‹¤
- êµ¬ì²´ì ì¸ ìˆ˜ì¹˜ì™€ ì‚¬ì‹¤ì„ ê·¼ê±°ë¡œ ë¶„ì„í•©ë‹ˆë‹¤
- ì°¬ë°˜ ë˜ëŠ” ë‹¤ì–‘í•œ ì‹œê°ì´ ì¡´ì¬í•œë‹¤ë©´ ê· í˜• ìˆê²Œ ì†Œê°œí•©ë‹ˆë‹¤

ë‹µë³€ì€ ë°˜ë“œì‹œ JSON í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.`
}

function buildInsightUserPrompt(title: string, content: string, expert: CategoryExpert, category: string): string {
  const frame = CATEGORY_ANALYSIS_FRAMES[category]
  const sections = frame?.sections || DEFAULT_SECTIONS

  return `ë‹¤ìŒ ë‰´ìŠ¤ì— ëŒ€í•´ ${expert.name}ë¡œì„œ ì „ë¬¸ì ì¸ ì˜ê²¬ì„ ì œê³µí•´ì£¼ì„¸ìš”.

**ë‰´ìŠ¤ ì œëª©:** ${title}

**ë‰´ìŠ¤ ë‚´ìš©:**
${content}

---

**ë¶„ì„ ìš”ì²­:**

${sections}

5. **ğŸ’¬ So What? - ë…ìë¥¼ ìœ„í•œ í•µì‹¬ ë©”ì‹œì§€** (1-2ì¤„)
   - "ì´ ë‰´ìŠ¤ê°€ ë‚˜ì—ê²Œ ì–´ë–¤ ì˜í–¥ì„ ì£¼ëŠ”ê°€?"
   - "ë¬´ì—‡ì„ ì£¼ëª©í•˜ê±°ë‚˜ ì¤€ë¹„í•´ì•¼ í•˜ëŠ”ê°€?"

**í‚¤ì›Œë“œ ì„ ì • ê¸°ì¤€:**
- ì´ ë‰´ìŠ¤ì˜ í•µì‹¬ ìŸì ì´ë‚˜ ê°œë…ì„ ë‚˜íƒ€ë‚´ëŠ” ë‹¨ì–´ 3-5ê°œ
- ê´€ë ¨ ë‰´ìŠ¤ë¥¼ ë” ì°¾ì„ ë•Œ ê²€ìƒ‰ì–´ë¡œ ìœ ìš©í•œ ë‹¨ì–´
- ë„ˆë¬´ ì¼ë°˜ì ì¸ ë‹¨ì–´(ì •ë¶€, êµ­íšŒ, ê¸°ì—… ë“±) ëŒ€ì‹  êµ¬ì²´ì ì¸ í‚¤ì›Œë“œ ì„ íƒ
- í•œê¸€ë¡œë§Œ ì‘ì„±

**ì¶œë ¥ í˜•ì‹ (ë°˜ë“œì‹œ JSON):**
{
  "insight": "ğŸ“Œ **[ì„¹ì…˜ ì œëª©]**\\nâ€¢ (ë¶„ì„ ë‚´ìš©)\\n\\nğŸ“Š **[ì„¹ì…˜ ì œëª©]**\\nâ€¢ (ë¶„ì„ ë‚´ìš©)\\n\\nâš¡ **[ì„¹ì…˜ ì œëª©]**\\nâ€¢ (ë¶„ì„ ë‚´ìš©)\\n\\nğŸ”® **[ì„¹ì…˜ ì œëª©]**\\nâ€¢ (ë¶„ì„ ë‚´ìš©)\\n\\nğŸ’¬ **So What?**\\nâ€¢ (ë…ìë¥¼ ìœ„í•œ í•µì‹¬ ë©”ì‹œì§€)",
  "keywords": ["í•µì‹¬í‚¤ì›Œë“œ1", "í•µì‹¬í‚¤ì›Œë“œ2", "í•µì‹¬í‚¤ì›Œë“œ3"]
}`
}

/**
 * POST /api/news/insight
 *
 * ê°œë³„ ë‰´ìŠ¤ì— ëŒ€í•œ ì „ë¬¸ê°€ ì˜ê²¬ ìƒì„± API
 * ë‰´ìŠ¤ì˜ ì¹´í…Œê³ ë¦¬ì— ë§ëŠ” ì „ë¬¸ê°€ ê´€ì ì—ì„œ ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤.
 * Fallback ìˆœì„œ: Groq -> Gemini -> OpenRouter
 */
export async function POST(request: NextRequest) {
  try {
    const body = await request.json()
    const { newsId, url, title, summary, category } = body

    // ìœ íš¨ì„± ê²€ì‚¬
    if (!newsId && !url) {
      return NextResponse.json(
        { error: 'newsId ë˜ëŠ” urlì´ í•„ìš”í•©ë‹ˆë‹¤.' },
        { status: 400 }
      )
    }

    // DBì—ì„œ ë‰´ìŠ¤ ì¡°íšŒ (ìºì‹œ í™•ì¸)
    let news = null
    if (newsId) {
      news = await prisma.news.findUnique({
        where: { id: newsId },
      })

      // ìºì‹œëœ ì¸ì‚¬ì´íŠ¸ê°€ ìˆìœ¼ë©´ ë°˜í™˜
      if (news?.aiInsight) {
        console.log('[NewsInsight] Returning cached insight')
        return NextResponse.json({
          success: true,
          data: {
            insight: news.aiInsight,
            expert: news.aiInsightExpert || '',
            keywords: news.aiInsightKeywords || [],
          },
          provider: news.aiInsightProvider || 'cached',
          cached: true,
        })
      }
    }

    // ë‰´ìŠ¤ ë³¸ë¬¸ ê°€ì ¸ì˜¤ê¸°
    let newsContent = ''
    const newsUrl = news?.url || url
    const newsTitle = news?.title || title
    const newsCategory = news?.category || category || 'general'

    if (newsUrl) {
      try {
        const scraped = await scrapeNewsContent(newsUrl)
        if (scraped && scraped.length > 100) {
          newsContent = scraped.slice(0, 3000)
        }
      } catch (error) {
        console.error('[NewsInsight] Scraping failed:', error)
      }
    }

    // ìŠ¤í¬ë˜í•‘ ì‹¤íŒ¨ ì‹œ summary ì‚¬ìš©
    if (!newsContent || newsContent.length < 100) {
      const fallbackSummary = news?.summary || summary
      if (fallbackSummary && fallbackSummary.length > 50) {
        newsContent = fallbackSummary
      } else {
        return NextResponse.json(
          { error: 'ë‰´ìŠ¤ ë³¸ë¬¸ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' },
          { status: 400 }
        )
      }
    }

    // ì „ë¬¸ê°€ ì„ íƒ ë° í”„ë¡¬í”„íŠ¸ ìƒì„±
    const expert = getExpert(newsCategory)
    const systemPrompt = buildInsightSystemPrompt(expert, newsCategory)
    const userPrompt = buildInsightUserPrompt(newsTitle, newsContent, expert, newsCategory)

    const baseOptions = {
      systemPrompt,
      userPrompt,
      temperature: 0.4,
      maxTokens: 3000,
      primaryField: 'insight',
      logPrefix: '[NewsInsight]',
    }

    // Groq â†’ Gemini â†’ OpenRouter í´ë°± ì‹¤í–‰
    const { result: aiResult, provider } = await runWithFallback<AIInsightResponse>(
      [
        {
          provider: 'groq',
          fn: () => callGroqJSON<AIInsightResponse>(baseOptions),
        },
        {
          provider: 'gemini',
          fn: () => callGeminiJSON<AIInsightResponse>({ ...baseOptions, geminiSchema: GEMINI_SCHEMA }),
        },
        {
          provider: 'openrouter',
          fn: () => callOpenRouterJSON<AIInsightResponse>(baseOptions),
        },
      ],
      '[NewsInsight]'
    )

    const result: InsightResult = {
      insight: aiResult.insight,
      expert: expert.name,
      keywords: aiResult.keywords || [],
    }

    // DBì— ì €ì¥ (newsIdê°€ ìˆëŠ” ê²½ìš°)
    if (newsId && news) {
      await prisma.news.update({
        where: { id: newsId },
        data: {
          aiInsight: result.insight,
          aiInsightExpert: expert.name,
          aiInsightKeywords: result.keywords || [],
          aiInsightAt: new Date(),
          aiInsightProvider: provider,
        },
      }).catch((err: unknown) => console.error('[NewsInsight] DB save failed:', err))
    }

    return NextResponse.json({
      success: true,
      data: result,
      provider,
      cached: false,
    })
  } catch (error) {
    if (error instanceof AllProvidersFailedError) {
      return NextResponse.json(
        {
          error: 'ëª¨ë“  AI í”„ë¡œë°”ì´ë” ì‹¤íŒ¨',
          details: error.details,
          attempts: error.attempts,
        },
        { status: 500 }
      )
    }

    console.error('[NewsInsight API Error]', error)
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'Unknown error' },
      { status: 500 }
    )
  }
}
