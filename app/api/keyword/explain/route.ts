import { NextRequest, NextResponse } from 'next/server'
import Groq from 'groq-sdk'

/**
 * POST /api/keyword/explain
 * í‚¤ì›Œë“œì— ëŒ€í•œ ìš©ì–´ ì„¤ëª… ìƒì„±
 */
export async function POST(request: NextRequest) {
  try {
    const { keyword } = await request.json()

    if (!keyword || typeof keyword !== 'string') {
      return NextResponse.json(
        { success: false, error: 'í‚¤ì›Œë“œê°€ í•„ìš”í•©ë‹ˆë‹¤.' },
        { status: 400 }
      )
    }

    console.log(`[KeywordExplain] ìš©ì–´ ì„¤ëª… ìš”ì²­: ${keyword}`)

    // Groq API í‚¤ í™•ì¸
    const apiKey = process.env.GROQ_API_KEY
    if (!apiKey) {
      throw new Error('GROQ_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.')
    }

    // Groq í´ë¼ì´ì–¸íŠ¸ ìƒì„±
    const groq = new Groq({ apiKey })

    // ìš©ì–´ ì„¤ëª… í”„ë¡¬í”„íŠ¸
    const prompt = `ë‹¤ìŒ ìš©ì–´ì— ëŒ€í•´ ì¼ë°˜ì¸ë„ ì´í•´í•˜ê¸° ì‰½ê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš”:

**ìš©ì–´**: ${keyword}

ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ **ì •í™•íˆ** ì„¤ëª…í•´ì£¼ì„¸ìš”:

ğŸ“Œ **í•µì‹¬ ì •ì˜**
â€¢ [í•œ ë¬¸ì¥ìœ¼ë¡œ í•µì‹¬ ê°œë… ì„¤ëª…]

ğŸ“š **ìƒì„¸ ì„¤ëª…**
â€¢ [ì¢€ ë” ìì„¸í•œ ì„¤ëª…, 2-3ë¬¸ì¥]

ğŸ’¡ **ì‹¤ìƒí™œ ì˜ˆì‹œ**
â€¢ [êµ¬ì²´ì ì¸ ì˜ˆì‹œë‚˜ ë¹„ìœ ë¡œ ì‰½ê²Œ ì„¤ëª…]

**ì ˆëŒ€ ê·œì¹™ - ë°˜ë“œì‹œ ì§€ì¼œì•¼ í•©ë‹ˆë‹¤:**
1. **í•œìë¥¼ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”**
   - æ¬Šç›Š (X) â†’ ê¶Œìµ (O)
   - åˆ©ç›Š (X) â†’ ì´ìµ (O)
   - æ¢ä»¶ (X) â†’ ì¡°ê±´ (O)
   - æ”¹å–„ (X) â†’ ê°œì„  (O)
   - ä¿è­· (X) â†’ ë³´í˜¸ (O)
   - çµ„ç¹” (X) â†’ ì¡°ì§ (O)
   - å®šç¾© (X) â†’ ì •ì˜ (O)
   - èªªæ˜ (X) â†’ ì„¤ëª… (O)

2. **ì˜¤ì§ í•œê¸€ë¡œë§Œ ì‘ì„±**
   - ì˜ì–´, ì¤‘êµ­ì–´, ì¼ë³¸ì–´ ë“± ì™¸êµ­ì–´ ë‹¨ì–´ ì ˆëŒ€ ê¸ˆì§€
   - ì™¸ë˜ì–´ë‚˜ ì˜ì–´ ì•½ì–´ë„ í•œê¸€ë¡œ í’€ì–´ì„œ ì„¤ëª… (AI â†’ ì¸ê³µì§€ëŠ¥, IoT â†’ ì‚¬ë¬¼ì¸í„°ë„·)

3. **ì„¹ì…˜ í—¤ë”ëŠ” ì •í™•íˆ**
   - "í•µì‹¬ ì •ì˜", "ìƒì„¸ ì„¤ëª…", "ì‹¤ìƒí™œ ì˜ˆì‹œ" ê·¸ëŒ€ë¡œ ì‚¬ìš©

4. **ì‰¬ìš´ ë§ë¡œ**
   - ì „ë¬¸ ìš©ì–´ ìµœì†Œí™”
   - ìˆœìš°ë¦¬ë§ê³¼ ì¼ìƒ í‘œí˜„ ì‚¬ìš©
   - êµ¬ì²´ì ì¸ ì˜ˆì‹œ í¬í•¨
   - ê° ì„¹ì…˜ì€ 2-3ê°œ ë¶ˆë¦¿ í¬ì¸íŠ¸ë¡œ ê°„ê²°í•˜ê²Œ

**ì¢‹ì€ ì˜ˆì‹œ:**
ğŸ“Œ **í•µì‹¬ ì •ì˜**
â€¢ ë¸”ë¡ì²´ì¸ì€ ê±°ë˜ ê¸°ë¡ì„ ì—¬ëŸ¬ ì»´í“¨í„°ì— ë‚˜ëˆ  ì €ì¥í•˜ëŠ” ê¸°ìˆ ì…ë‹ˆë‹¤

ğŸ“š **ìƒì„¸ ì„¤ëª…**
â€¢ ì€í–‰ ì¥ë¶€ì²˜ëŸ¼ ê±°ë˜ ë‚´ì—­ì„ ê¸°ë¡í•˜ì§€ë§Œ, í•œ ê³³ì´ ì•„ë‹Œ ì—¬ëŸ¬ ê³³ì— ë˜‘ê°™ì´ ë³´ê´€í•©ë‹ˆë‹¤
â€¢ ëˆ„êµ°ê°€ ê¸°ë¡ì„ ì¡°ì‘í•˜ë ¤ë©´ ëª¨ë“  ì»´í“¨í„°ì˜ ê¸°ë¡ì„ ë™ì‹œì— ë°”ê¿”ì•¼ í•´ì„œ ì‚¬ì‹¤ìƒ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤

ğŸ’¡ **ì‹¤ìƒí™œ ì˜ˆì‹œ**
â€¢ ì¹œêµ¬ë“¤ê³¼ ëˆì„ ë¹Œë ¤ì£¼ê³  ë°›ì„ ë•Œ, í•œ ëª…ì´ ì•„ë‹Œ ëª¨ë“  ì¹œêµ¬ê°€ ê°ì ì¥ë¶€ì— ê¸°ë¡í•˜ëŠ” ê²ƒê³¼ ê°™ìŠµë‹ˆë‹¤`

    console.log('[KeywordExplain] Groq API ìš”ì²­ ì‹œì‘...')

    // Groq API í˜¸ì¶œ
    const response = await groq.chat.completions.create({
      model: 'llama-3.3-70b-versatile',
      messages: [
        {
          role: 'system',
          content:
            'ë‹¹ì‹ ì€ ì „ë¬¸ ìš©ì–´ë¥¼ ì¼ë°˜ì¸ë„ ì‰½ê²Œ ì´í•´í•  ìˆ˜ ìˆë„ë¡ ì„¤ëª…í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. **ì ˆëŒ€ ê·œì¹™**: í•œìë¥¼ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. æ¬Šç›Š(X)â†’ê¶Œìµ(O), åˆ©ç›Š(X)â†’ì´ìµ(O), æ¢ä»¶(X)â†’ì¡°ê±´(O), æ”¹å–„(X)â†’ê°œì„ (O), ä¿è­·(X)â†’ë³´í˜¸(O), çµ„ç¹”(X)â†’ì¡°ì§(O) ì²˜ëŸ¼ í•œê¸€ë¡œë§Œ ì‘ì„±í•©ë‹ˆë‹¤. ì˜ì–´ë‚˜ ë‹¤ë¥¸ ì™¸êµ­ì–´ ë‹¨ì–´ë„ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì™¸ë˜ì–´ë‚˜ ì˜ì–´ ì•½ì–´ëŠ” ë°˜ë“œì‹œ í•œê¸€ë¡œ í’€ì–´ì“°ê³  ì„¤ëª…í•©ë‹ˆë‹¤ (ì˜ˆ: APIâ†’í”„ë¡œê·¸ë¨ ì—°ê²° ì¸í„°í˜ì´ìŠ¤). ì „ë¬¸ ìš©ì–´ëŠ” ìµœì†Œí™”í•˜ê³ , êµ¬ì²´ì ì¸ ì˜ˆì‹œì™€ ë¹„ìœ ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‰½ê²Œ ì„¤ëª…í•©ë‹ˆë‹¤. í•œìì–´ ëŒ€ì‹  ì‰¬ìš´ ìˆœìš°ë¦¬ë§ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ì„¹ì…˜ í—¤ë”ëŠ” ì£¼ì–´ì§„ í˜•ì‹ì„ ì •í™•íˆ ë”°ë¦…ë‹ˆë‹¤.',
        },
        {
          role: 'user',
          content: prompt,
        },
      ],
      temperature: 0.3, // ì¼ê´€ì„± ìˆëŠ” í•œêµ­ì–´ ì‘ë‹µì„ ìœ„í•´ ë‚®ì¶¤ (0.5 â†’ 0.3)
      max_tokens: 1500,
    })

    const explanation = response.choices[0]?.message?.content

    if (!explanation) {
      throw new Error('AI ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.')
    }

    // í•œì ê²€ì¦ (U+4E00-U+9FFF: CJK í†µí•© í•œì, U+3400-U+4DBF: CJK í™•ì¥ A)
    const chineseCharRegex = /[\u4E00-\u9FFF\u3400-\u4DBF]/g
    const foundChinese = explanation.match(chineseCharRegex)

    if (foundChinese && foundChinese.length > 0) {
      console.warn(
        `[KeywordExplain] í•œì ë°œê²¬: ${foundChinese.join(', ')} - ì¬ì‹œë„`
      )

      // í•œìê°€ ë°œê²¬ë˜ë©´ ë” ê°•ë ¥í•œ í”„ë¡¬í”„íŠ¸ë¡œ ì¬ì‹œë„
      const retryPrompt = `${prompt}

**ì ˆëŒ€ì ìœ¼ë¡œ ì¤‘ìš” - í•œì ì‚¬ìš© ì ˆëŒ€ ê¸ˆì§€:**
- æ¬Šç›Š (X) â†’ ê¶Œìµ (O)
- åˆ©ç›Š (X) â†’ ì´ìµ (O)
- æ¢ä»¶ (X) â†’ ì¡°ê±´ (O)
- æ”¹å–„ (X) â†’ ê°œì„  (O)
- ä¿è­· (X) â†’ ë³´í˜¸ (O)
- çµ„ç¹” (X) â†’ ì¡°ì§ (O)
- í•œê¸€ë¡œë§Œ ì‘ì„±í•˜ì„¸ìš”. í•œìë¥¼ ì„ì§€ ë§ˆì„¸ìš”.`

      const retryResponse = await groq.chat.completions.create({
        model: 'llama-3.3-70b-versatile',
        messages: [
          {
            role: 'system',
            content:
              'ë‹¹ì‹ ì€ ì „ë¬¸ ìš©ì–´ë¥¼ ì¼ë°˜ì¸ë„ ì‰½ê²Œ ì´í•´í•  ìˆ˜ ìˆë„ë¡ ì„¤ëª…í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. **ì ˆëŒ€ ê·œì¹™**: í•œìë¥¼ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. æ¬Šç›Š(X)â†’ê¶Œìµ(O), åˆ©ç›Š(X)â†’ì´ìµ(O), æ¢ä»¶(X)â†’ì¡°ê±´(O) ì²˜ëŸ¼ í•œê¸€ë¡œë§Œ ì‘ì„±í•©ë‹ˆë‹¤. ì˜ì–´ë‚˜ ë‹¤ë¥¸ ì™¸êµ­ì–´ ë‹¨ì–´ë„ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì™¸ë˜ì–´ë‚˜ ì˜ì–´ ì•½ì–´ëŠ” ë°˜ë“œì‹œ í•œê¸€ë¡œ í’€ì–´ì“°ê³  ì„¤ëª…í•©ë‹ˆë‹¤ (ì˜ˆ: APIâ†’í”„ë¡œê·¸ë¨ ì—°ê²° ì¸í„°í˜ì´ìŠ¤, SaaSâ†’êµ¬ë…í˜• ì†Œí”„íŠ¸ì›¨ì–´ ì„œë¹„ìŠ¤). ì „ë¬¸ ìš©ì–´ëŠ” ìµœì†Œí™”í•˜ê³ , êµ¬ì²´ì ì¸ ì˜ˆì‹œì™€ ë¹„ìœ ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‰½ê²Œ ì„¤ëª…í•©ë‹ˆë‹¤. í•œìì–´ ëŒ€ì‹  ì‰¬ìš´ ìˆœìš°ë¦¬ë§ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ì„¹ì…˜ í—¤ë”ëŠ” ì£¼ì–´ì§„ í˜•ì‹ì„ ì •í™•íˆ ë”°ë¦…ë‹ˆë‹¤.',
          },
          {
            role: 'user',
            content: retryPrompt,
          },
        ],
        temperature: 0.3, // ë” ë‚®ì¶¤ (0.5 â†’ 0.3)
        max_tokens: 1500,
      })

      const retryExplanation = retryResponse.choices[0]?.message?.content

      if (!retryExplanation) {
        throw new Error('AI ì¬ì‹œë„ ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.')
      }

      console.log(
        `[KeywordExplain] ì¬ì‹œë„ ì„±ê³µ (${retryExplanation.length}ì)`
      )

      return NextResponse.json({
        success: true,
        data: {
          keyword,
          explanation: retryExplanation,
          provider: 'groq',
        },
      })
    }

    console.log(`[KeywordExplain] Groq ì‘ë‹µ ì„±ê³µ (${explanation.length}ì)`)

    return NextResponse.json({
      success: true,
      data: {
        keyword,
        explanation,
        provider: 'groq',
      },
    })
  } catch (error) {
    console.error('[KeywordExplain] Error:', error)

    return NextResponse.json(
      {
        success: false,
        error:
          error instanceof Error
            ? error.message
            : 'ìš©ì–´ ì„¤ëª… ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      },
      { status: 500 }
    )
  }
}
