import { NextRequest, NextResponse } from 'next/server'
import { FEATURE_FLAGS } from '@/lib/feature-flags'
import { CATEGORY_EXPERTS, CATEGORY_NAMES } from '@/lib/ai/experts'
import {
  callGroqJSON,
  callGeminiJSON,
  callOpenRouterJSON,
  runWithFallback,
  AllProvidersFailedError,
} from '@/lib/ai/generate'

interface NewsItem {
  title: string
  summary: string
  source: string
  category: string
}

interface InsightResult {
  insights: string
  keywords: string[]
}

// Gemini ì‘ë‹µ ìŠ¤í‚¤ë§ˆ (insights + keywords)
const GEMINI_SCHEMA = {
  type: 'object',
  properties: {
    insights: {
      type: 'string',
      description: 'ë‰´ìŠ¤ ë¶„ì„ ì¸ì‚¬ì´íŠ¸ í…ìŠ¤íŠ¸ (ë§ˆí¬ë‹¤ìš´ í˜•ì‹)',
    },
    keywords: {
      type: 'array',
      items: { type: 'string' },
      description: 'í•µì‹¬ í‚¤ì›Œë“œ 5ê°œ',
    },
  },
  required: ['insights', 'keywords'],
}

// â”€â”€ ì¹´í…Œê³ ë¦¬ë³„ ë¶„ì„ ë Œì¦ˆ â”€â”€

const CATEGORY_ANALYSIS_LENS: Record<string, {
  focusAreas: string
  connectionHint: string
}> = {
  politics: {
    focusAreas: `- ê¶Œë ¥ ì—­í•™: ì—¬ë‹¹/ì•¼ë‹¹/ëŒ€í†µë ¹/ì‹œë¯¼ì‚¬íšŒ ê°„ í˜ì˜ ê· í˜• ë³€í™”
- ì •ì±… ì‹¤íš¨ì„±: ë°œí‘œëœ ì •ì±…ì´ ì‹¤ì œë¡œ ì‘ë™í•  ê°€ëŠ¥ì„±ê³¼ ì¥ì• ë¬¼
- ì—¬ë¡  íë¦„: êµ­ë¯¼ ë°˜ì‘, ì§€ì§€ìœ¨ ë³€ë™, ì„ ê±° ì˜í–¥`,
    connectionHint: 'ì •ì¹˜ ë‰´ìŠ¤ë“¤ ì‚¬ì´ì—ì„œ ê³µí†µëœ ê¶Œë ¥ ì´ë™ íŒ¨í„´ì´ë‚˜ ì •ì±… ë°©í–¥ì˜ ì¼ê´€ì„±/ëª¨ìˆœì„ ì°¾ì•„ë‚´ì„¸ìš”.',
  },
  economy: {
    focusAreas: `- ì‹œì¥ ì‹ í˜¸: ê¸ˆë¦¬, í™˜ìœ¨, ì£¼ê°€ ë“± ì§€í‘œê°€ ê°€ë¦¬í‚¤ëŠ” ë°©í–¥
- ì‚°ì—… ì˜í–¥: ì–´ë–¤ ì‚°ì—…ì´ ìˆ˜í˜œ/í”¼í•´ë¥¼ ë°›ëŠ”ì§€, ë°¸ë¥˜ì²´ì¸ íŒŒê¸‰ íš¨ê³¼
- íˆ¬ì ì‹œì‚¬ì : ê°œì¸ íˆ¬ììì™€ ê¸°ì—…ì´ ì£¼ëª©í•´ì•¼ í•  í¬ì¸íŠ¸`,
    connectionHint: 'ê²½ì œ ë‰´ìŠ¤ë“¤ì´ ê³µí†µì ìœ¼ë¡œ ê°€ë¦¬í‚¤ëŠ” ê±°ì‹œê²½ì œ ë°©í–¥ì„±ì´ë‚˜ ì‚°ì—… íŠ¸ë Œë“œë¥¼ ì—°ê²°í•˜ì„¸ìš”.',
  },
  society: {
    focusAreas: `- êµ¬ì¡°ì  ì›ì¸: ì‚¬ê±´/í˜„ìƒ ë’¤ì— ìˆëŠ” ì‚¬íšŒ ì‹œìŠ¤í…œ ë¬¸ì œ
- ì‹œë¯¼ ì˜í–¥: ì¼ë°˜ êµ­ë¯¼ì˜ ìƒí™œì— ì§ì ‘ ë¯¸ì¹˜ëŠ” ì˜í–¥ê³¼ ê·œëª¨
- ì œë„ ë³€í™”: ê´€ë ¨ ë²•/ì œë„/ì •ì±…ì˜ ë³€í™” ê°€ëŠ¥ì„±`,
    connectionHint: 'ì‚¬íšŒ ë‰´ìŠ¤ë“¤ì—ì„œ ê³µí†µëœ ì‚¬íšŒ êµ¬ì¡° ë³€í™”ë‚˜ ì‹œë¯¼ ìƒí™œ ì˜í–¥ íŒ¨í„´ì„ ì°¾ì•„ë‚´ì„¸ìš”.',
  },
  world: {
    focusAreas: `- ì§€ì •í•™ ì—­í•™: ì£¼ìš”êµ­ ê°„ í˜ì˜ ê· í˜•, ë™ë§¹ ê´€ê³„ ë³€í™”
- í•œêµ­ ì˜í–¥: êµ­ì œ ë‰´ìŠ¤ê°€ í•œêµ­ ê²½ì œ/ì™¸êµ/ì•ˆë³´ì— ë¯¸ì¹˜ëŠ” ì˜í–¥
- ê¸€ë¡œë²Œ íŠ¸ë Œë“œ: ì„¸ê³„ì ìœ¼ë¡œ ê³µí†µë˜ëŠ” íë¦„ì´ë‚˜ íŒ¨í„´`,
    connectionHint: 'êµ­ì œ ë‰´ìŠ¤ë“¤ì´ ê³µí†µì ìœ¼ë¡œ ë³´ì—¬ì£¼ëŠ” ì„¸ê³„ ì§ˆì„œ ë³€í™” ë°©í–¥ì„ ì—°ê²°í•˜ì„¸ìš”.',
  },
  tech: {
    focusAreas: `- í˜ì‹  ìˆ˜ì¤€: ê¸°ì¡´ ê¸°ìˆ  ëŒ€ë¹„ ì–¼ë§ˆë‚˜ í° ë³€í™”ì¸ì§€ (ì ì§„ì  vs íŒŒê´´ì )
- ì‹œì¥ íŒŒê¸‰ë ¥: ê´€ë ¨ ì‚°ì—…ê³¼ ê¸°ì—…ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ ê·œëª¨
- ìƒí™œ ë³€í™”: ì¼ë°˜ì¸ì˜ ì¼ìƒì´ ì–´ë–»ê²Œ ë°”ë€ŒëŠ”ì§€`,
    connectionHint: 'IT ë‰´ìŠ¤ë“¤ì´ ê³µí†µì ìœ¼ë¡œ ê°€ë¦¬í‚¤ëŠ” ê¸°ìˆ  ë°œì „ ë°©í–¥ì´ë‚˜ ì‚°ì—… ì¬í¸ íë¦„ì„ ì—°ê²°í•˜ì„¸ìš”.',
  },
  crypto: {
    focusAreas: `- ì‹œì¥ ì‹¬ë¦¬: ê³µí¬/íƒìš• ì§€ìˆ˜, ê¸°ê´€ íˆ¬ìì ë™í–¥, ê±°ë˜ëŸ‰ ë³€í™”
- ê·œì œ í™˜ê²½: ê°êµ­ ì •ë¶€ì˜ ê·œì œ ë°©í–¥ê³¼ ì‹œì¥ ë°˜ì‘
- ê¸°ìˆ  ë°œì „: ë¸”ë¡ì²´ì¸/DeFi/NFT ë“± ê¸°ìˆ ì  ì§„ì „ê³¼ ì‹¤ì‚¬ìš© ì‚¬ë¡€`,
    connectionHint: 'ì•”í˜¸í™”í ë‰´ìŠ¤ë“¤ì´ ê³µí†µì ìœ¼ë¡œ ê°€ë¦¬í‚¤ëŠ” ì‹œì¥ ë°©í–¥ì„±ì´ë‚˜ ê·œì œ íŠ¸ë Œë“œë¥¼ ì—°ê²°í•˜ì„¸ìš”.',
  },
  global: {
    focusAreas: `- ê¸€ë¡œë²Œ ê²½ì œ íë¦„: ì£¼ìš”êµ­ ê²½ì œì§€í‘œ, ë¬´ì—­ ë™í–¥, í†µí™”ì •ì±…
- ì§€ì •í•™ ë¦¬ìŠ¤í¬: ë¶„ìŸ, ì œì¬, ë™ë§¹ ê´€ê³„ ë³€í™”
- í•œêµ­ ê¸°ì—… ì˜í–¥: ìˆ˜ì¶œì…, ê³µê¸‰ë§, íˆ¬ì í™˜ê²½ì— ë¯¸ì¹˜ëŠ” ì˜í–¥`,
    connectionHint: 'ê¸€ë¡œë²Œ ë‰´ìŠ¤ë“¤ì´ ê³µí†µì ìœ¼ë¡œ ë³´ì—¬ì£¼ëŠ” ì„¸ê³„ ê²½ì œ/ì •ì¹˜ ë°©í–¥ì„±ì„ ì—°ê²°í•˜ì„¸ìš”.',
  },
  sports: {
    focusAreas: `- ê²½ê¸°ë ¥ ë¶„ì„: í•µì‹¬ ìŠ¹ë¶€ì²˜, ì „ìˆ  ë³€í™”, ì„ ìˆ˜ ì»¨ë””ì…˜
- ê¸°ë¡ê³¼ ì„±ì·¨: ì—­ëŒ€ ê¸°ë¡, ì‹œì¦Œ íë¦„, ìˆœìœ„ ë³€ë™
- ìŠ¤í¬ì¸  ì‚°ì—…: ì´ì  ì‹œì¥, ì¤‘ê³„ê¶Œ, êµ¬ë‹¨ ê²½ì˜`,
    connectionHint: 'ìŠ¤í¬ì¸  ë‰´ìŠ¤ë“¤ì—ì„œ ê³µí†µëœ ì‹œì¦Œ íë¦„ì´ë‚˜ ìŠ¤í¬ì¸  ì‚°ì—… íŠ¸ë Œë“œë¥¼ ì°¾ì•„ë‚´ì„¸ìš”.',
  },
  entertainment: {
    focusAreas: `- ì½˜í…ì¸  ì„±ê³¼: ì‹œì²­ë¥ , ìŒì› ì°¨íŠ¸, í¥í–‰ ìˆ˜ì¹˜ ë“± ê°ê´€ì  ë°ì´í„°
- í•œë¥˜ íŠ¸ë Œë“œ: ê¸€ë¡œë²Œ ì‹œì¥ì—ì„œì˜ í•œêµ­ ì½˜í…ì¸  ìœ„ìƒ ë³€í™”
- ì—…ê³„ ë™í–¥: ê¸°íšì‚¬/í”Œë«í¼ ì „ëµ, ì•„í‹°ìŠ¤íŠ¸ í™œë™ ë°©í–¥`,
    connectionHint: 'ì—°ì˜ˆ ë‰´ìŠ¤ë“¤ì´ ê³µí†µì ìœ¼ë¡œ ë³´ì—¬ì£¼ëŠ” ì½˜í…ì¸  ì‹œì¥ íŠ¸ë Œë“œë‚˜ í•œë¥˜ ë°©í–¥ì„±ì„ ì—°ê²°í•˜ì„¸ìš”.',
  },
  culture: {
    focusAreas: `- ë¬¸í™”ì  ê°€ì¹˜: ì‘í’ˆ/í–‰ì‚¬ì˜ ì˜ˆìˆ ì Â·ì—­ì‚¬ì  ì˜ë¯¸
- ëŒ€ì¤‘ ì ‘ê·¼ì„±: ê´€ëŒ/ì°¸ì—¬ ê¸°íšŒì™€ ë¬¸í™” í–¥ìœ  í™•ëŒ€
- ì‚¬íšŒì  ì˜í–¥: ë¬¸í™”ê°€ ì‚¬íšŒ ì¸ì‹ì´ë‚˜ ê°€ì¹˜ê´€ì— ë¯¸ì¹˜ëŠ” ì˜í–¥`,
    connectionHint: 'ë¬¸í™” ë‰´ìŠ¤ë“¤ì—ì„œ ê³µí†µëœ ë¬¸í™” íŠ¸ë Œë“œë‚˜ ì‚¬íšŒì  ì˜ë¯¸ë¥¼ ì°¾ì•„ë‚´ì„¸ìš”.',
  },
}

// â”€â”€ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ â”€â”€

// ì¢…í•© íƒ­ìš© ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
const GENERAL_SYSTEM_PROMPT = `ë‹¹ì‹ ì€ ë‹¤ì–‘í•œ ë¶„ì•¼ì— ì •í†µí•œ **ìˆ˜ì„ ë‰´ìŠ¤ ì• ë„ë¦¬ìŠ¤íŠ¸**ì…ë‹ˆë‹¤.

**ë‹¹ì‹ ì˜ í•µì‹¬ ì—­ëŸ‰:**
- ì„œë¡œ ë‹¤ë¥¸ ë¶„ì•¼ì˜ ë‰´ìŠ¤ë“¤ ì‚¬ì´ì—ì„œ ìˆ¨ê²¨ì§„ ì—°ê²°ê³ ë¦¬ë¥¼ ë°œê²¬í•˜ëŠ” í†µì°°ë ¥
- ê°œë³„ ì‚¬ê±´ ë„ˆë¨¸ì˜ í° ê·¸ë¦¼(macro picture)ì„ í¬ì°©í•˜ëŠ” ì¢…í•© ë¶„ì„ë ¥
- "ì™œ ì´ê²ƒì´ ì¤‘ìš”í•œê°€"ë¥¼ ë…ì ê´€ì ì—ì„œ ëª…í™•íˆ ì„¤ëª…í•˜ëŠ” ëŠ¥ë ¥

**ë¶„ì„ ì›ì¹™:**
- ë‰´ìŠ¤ë¥¼ ê°œë³„ì ìœ¼ë¡œ ìš”ì•½í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‰´ìŠ¤ ê°„ ì—°ê²°ê³ ë¦¬ë¥¼ ì°¾ì•„ í° ê·¸ë¦¼ì„ ê·¸ë¦½ë‹ˆë‹¤
- í‘œë©´ì  ì‚¬ì‹¤ë³´ë‹¤ ê·¸ ë’¤ì— ìˆëŠ” êµ¬ì¡°ì  ë³€í™”ë‚˜ íŠ¸ë Œë“œë¥¼ ë¶„ì„í•©ë‹ˆë‹¤
- ëª¨ë“  ì£¼ì¥ì—ëŠ” ê¸°ì‚¬ì˜ êµ¬ì²´ì  ìˆ˜ì¹˜ë‚˜ ì‚¬ì‹¤ì„ ê·¼ê±°ë¡œ ì œì‹œí•©ë‹ˆë‹¤
- ë‹¤ì–‘í•œ ì´í•´ê´€ê³„ìì˜ ê´€ì ì„ ê· í˜• ìˆê²Œ ë‹¤ë£¹ë‹ˆë‹¤

**ì–¸ì–´ ê·œì¹™:**
- í•œêµ­ì–´ë¡œ ì‘ì„±í•©ë‹ˆë‹¤
- ì¼ìƒì ìœ¼ë¡œ í†µìš©ë˜ëŠ” í•œìì–´ëŠ” ìì—°ìŠ¤ëŸ½ê²Œ ì‚¬ìš©í•©ë‹ˆë‹¤ (ë°œí‘œ, ì¶”ì§„, ì‹œí–‰, ê²€í† , ê°œì„  ë“±)
- ì „ë¬¸ ìš©ì–´ëŠ” ê´„í˜¸ ì•ˆì— ì‰¬ìš´ ì„¤ëª…ì„ ë§ë¶™ì…ë‹ˆë‹¤
- ì˜ì–´ ì•½ì–´ëŠ” í•œê¸€ë¡œ í’€ì–´ì“°ë˜, ë„ë¦¬ ì•Œë ¤ì§„ ì•½ì–´(AI, IT, GDP ë“±)ëŠ” ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤

ë‹µë³€ì€ ë°˜ë“œì‹œ JSON í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.`

// ì¹´í…Œê³ ë¦¬ë³„ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ìƒì„±
function getSystemPrompt(category: string | null): string {
  if (!category || category === 'general') {
    return GENERAL_SYSTEM_PROMPT
  }

  const expert = CATEGORY_EXPERTS[category]
  if (!expert) {
    return GENERAL_SYSTEM_PROMPT
  }

  const lens = CATEGORY_ANALYSIS_LENS[category]
  const focusBlock = lens
    ? `\n**ë¶„ì„ ì´ˆì :**\n${lens.focusAreas}\n`
    : ''

  return `ë‹¹ì‹ ì€ **${expert.name}**ì…ë‹ˆë‹¤.

**ë‹¹ì‹ ì˜ ì „ë¬¸ì„±:**
${expert.expertise}

**ë‹¹ì‹ ì˜ ë¶„ì„ ê´€ì :**
${expert.perspective}
${focusBlock}
**ë¶„ì„ ì›ì¹™:**
- ë‰´ìŠ¤ë¥¼ ê°œë³„ì ìœ¼ë¡œ ìš”ì•½í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‰´ìŠ¤ ê°„ ì—°ê²°ê³ ë¦¬ë¥¼ ì°¾ì•„ ë¶„ì•¼ì˜ í° íë¦„ì„ ë¶„ì„í•©ë‹ˆë‹¤
- ì—…ê³„ ë‚´ë¶€ìì˜ ì‹œê°ìœ¼ë¡œ ì¼ë°˜ì¸ì´ ë†“ì¹˜ê¸° ì‰¬ìš´ ì˜ë¯¸ë¥¼ ì§šì–´ì¤ë‹ˆë‹¤
- ê³¼ê±° ì‚¬ë¡€ì™€ ë¹„êµí•˜ì—¬ í˜„ì¬ ìƒí™©ì˜ ì¤‘ìš”ë„ë¥¼ íŒë‹¨í•©ë‹ˆë‹¤
- ëª¨ë“  ì£¼ì¥ì—ëŠ” ê¸°ì‚¬ì˜ êµ¬ì²´ì  ìˆ˜ì¹˜ë‚˜ ì‚¬ì‹¤ì„ ê·¼ê±°ë¡œ ì œì‹œí•©ë‹ˆë‹¤

**ì–¸ì–´ ê·œì¹™:**
- í•œêµ­ì–´ë¡œ ì‘ì„±í•©ë‹ˆë‹¤
- ì¼ìƒì ìœ¼ë¡œ í†µìš©ë˜ëŠ” í•œìì–´ëŠ” ìì—°ìŠ¤ëŸ½ê²Œ ì‚¬ìš©í•©ë‹ˆë‹¤ (ë°œí‘œ, ì¶”ì§„, ì‹œí–‰, ê²€í† , ê°œì„  ë“±)
- ì „ë¬¸ ìš©ì–´ëŠ” ê´„í˜¸ ì•ˆì— ì‰¬ìš´ ì„¤ëª…ì„ ë§ë¶™ì…ë‹ˆë‹¤

ë‹µë³€ì€ ë°˜ë“œì‹œ JSON í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.`
}

// â”€â”€ ìœ ì € í”„ë¡¬í”„íŠ¸ â”€â”€

// ì¢…í•© íƒ­ìš© í”„ë¡¬í”„íŠ¸
function createGeneralPrompt(newsText: string, newsCount: number): string {
  return `ë‹¤ìŒì€ ì˜¤ëŠ˜ì˜ ì£¼ìš” ë‰´ìŠ¤ ${newsCount}ê°œì…ë‹ˆë‹¤. ìˆ˜ì„ ì• ë„ë¦¬ìŠ¤íŠ¸ë¡œì„œ ë‰´ìŠ¤ë“¤ì„ ì¢…í•© ë¶„ì„í•´ì£¼ì„¸ìš”.

${newsText}

---

**ë¶„ì„ ìš”ì²­:**

1. **ğŸ” ì˜¤ëŠ˜ì˜ í•œ ì¤„**
   - ì˜¤ëŠ˜ ë‰´ìŠ¤ë“¤ì´ ì „í•˜ëŠ” ê°€ì¥ ì¤‘ìš”í•œ ë©”ì‹œì§€ë¥¼ í•œ ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½

2. **ğŸ“Š ì£¼ìš” ì´ìŠˆ ë¶„ì„** (3-5ê°œ í…Œë§ˆë¡œ ê·¸ë£¹í™”)
   - ì„œë¡œ ê´€ë ¨ëœ ë‰´ìŠ¤ë“¤ì„ í…Œë§ˆë³„ë¡œ ë¬¶ì–´ì„œ ë¶„ì„
   - ê° í…Œë§ˆ: ë¬´ìŠ¨ ì¼ì´ ì¼ì–´ë‚˜ê³  ìˆëŠ”ì§€ + ì™œ ì¤‘ìš”í•œì§€ë¥¼ 2-3ì¤„ë¡œ ì •ë¦¬
   - ê¸°ì‚¬ì˜ êµ¬ì²´ì  ìˆ˜ì¹˜, ì¸ë¬¼, ê¸°ê´€ëª…ì„ ê·¼ê±°ë¡œ í¬í•¨
   - ì„œë¡œ ë‹¤ë¥¸ í…Œë§ˆ ê°„ ì—°ê²°ê³ ë¦¬ê°€ ìˆë‹¤ë©´ ë°˜ë“œì‹œ ì–¸ê¸‰

3. **ğŸ’¡ ìˆ˜ì„ ì• ë„ë¦¬ìŠ¤íŠ¸ì˜ ì¢…í•© ì¸ì‚¬ì´íŠ¸**
   - **í° ê·¸ë¦¼**: ê°œë³„ ë‰´ìŠ¤ë¥¼ ë„˜ì–´ì„œ, ì˜¤ëŠ˜ ë‰´ìŠ¤ë“¤ì´ ê³µí†µì ìœ¼ë¡œ ê°€ë¦¬í‚¤ëŠ” ë°©í–¥ì´ë‚˜ íŠ¸ë Œë“œ (2-3ì¤„)
   - **ì£¼ëª©í•  ë³€í™”**: ì´ì „ê³¼ ë‹¬ë¼ì§„ íë¦„, ìƒˆë¡œìš´ ì‹ í˜¸ (1-2ì¤„)
   - **í–¥í›„ ì „ë§**: ì´ íë¦„ì´ ê³„ì†ëœë‹¤ë©´ ì˜ˆìƒë˜ëŠ” ì „ê°œ ë°©í–¥ (1-2ì¤„)
   - **ë…ìì—ê²Œ**: ì´ ìƒí™©ì—ì„œ ìš°ë¦¬ê°€ ê´€ì‹¬ì„ ê°€ì ¸ì•¼ í•  ê²ƒ (1-2ì¤„)

4. **ğŸ”‘ í•µì‹¬ í‚¤ì›Œë“œ** 5ê°œ

**í‚¤ì›Œë“œ ì„ ì • ê¸°ì¤€:**
- ì´ ë‰´ìŠ¤ë“¤ì˜ í•µì‹¬ ìŸì ì´ë‚˜ ê°œë…ì„ ë‚˜íƒ€ë‚´ëŠ” ë‹¨ì–´
- ê´€ë ¨ ë‰´ìŠ¤ë¥¼ ë” ì°¾ì„ ë•Œ ê²€ìƒ‰ì–´ë¡œ ìœ ìš©í•œ ë‹¨ì–´
- ë„ˆë¬´ ì¼ë°˜ì ì¸ ë‹¨ì–´(ì •ë¶€, êµ­íšŒ, ê¸°ì—… ë“±) ëŒ€ì‹  êµ¬ì²´ì ì¸ í‚¤ì›Œë“œ
- í•œê¸€ë¡œë§Œ ì‘ì„±

**ì¶œë ¥ í˜•ì‹ (ë°˜ë“œì‹œ JSON):**
{
  "insights": "ğŸ” **ì˜¤ëŠ˜ì˜ í•œ ì¤„**\\n\\n(í•œ ë¬¸ì¥ ìš”ì•½)\\n\\nğŸ“Š **ì£¼ìš” ì´ìŠˆ ë¶„ì„**\\n\\n**1. [í…Œë§ˆëª…]**\\nâ€¢ (ë¶„ì„ 2-3ì¤„, ìˆ˜ì¹˜/ì‚¬ì‹¤ ê·¼ê±° í¬í•¨)\\n\\n**2. [í…Œë§ˆëª…]**\\nâ€¢ (ë¶„ì„ 2-3ì¤„)\\n\\nğŸ’¡ **ìˆ˜ì„ ì• ë„ë¦¬ìŠ¤íŠ¸ì˜ ì¢…í•© ì¸ì‚¬ì´íŠ¸**\\n\\n**í° ê·¸ë¦¼**\\nâ€¢ (2-3ì¤„)\\n\\n**ì£¼ëª©í•  ë³€í™”**\\nâ€¢ (1-2ì¤„)\\n\\n**í–¥í›„ ì „ë§**\\nâ€¢ (1-2ì¤„)\\n\\n**ë…ìì—ê²Œ**\\nâ€¢ (1-2ì¤„)",
  "keywords": ["í‚¤ì›Œë“œ1", "í‚¤ì›Œë“œ2", "í‚¤ì›Œë“œ3", "í‚¤ì›Œë“œ4", "í‚¤ì›Œë“œ5"]
}`
}

// ì¹´í…Œê³ ë¦¬ë³„ ì „ë¬¸ê°€ í”„ë¡¬í”„íŠ¸
function createCategoryPrompt(newsText: string, newsCount: number, category: string): string {
  const categoryName = CATEGORY_NAMES[category] || category
  const expert = CATEGORY_EXPERTS[category]
  const expertName = expert?.name || 'ì „ë¬¸ ì• ë„ë¦¬ìŠ¤íŠ¸'
  const lens = CATEGORY_ANALYSIS_LENS[category]
  const connectionHint = lens?.connectionHint || 'ë‰´ìŠ¤ë“¤ ì‚¬ì´ì˜ ê³µí†µëœ íë¦„ì´ë‚˜ ì—°ê²°ê³ ë¦¬ë¥¼ ì°¾ì•„ë‚´ì„¸ìš”.'

  return `ë‹¤ìŒì€ ì˜¤ëŠ˜ì˜ ${categoryName} ë¶„ì•¼ ì£¼ìš” ë‰´ìŠ¤ ${newsCount}ê°œì…ë‹ˆë‹¤. ${expertName}ë¡œì„œ ì „ë¬¸ì ì¸ ë¶„ì„ì„ ì œê³µí•´ì£¼ì„¸ìš”.

${newsText}

---

**ë¶„ì„ ì§€ì¹¨:** ${connectionHint}

**ë¶„ì„ ìš”ì²­:**

1. **ğŸ” ì˜¤ëŠ˜ì˜ í•œ ì¤„**
   - ${categoryName} ë¶„ì•¼ì—ì„œ ì˜¤ëŠ˜ ê°€ì¥ ì£¼ëª©í•  ë©”ì‹œì§€ë¥¼ í•œ ë¬¸ì¥ìœ¼ë¡œ

2. **ğŸ“Š í•µì‹¬ ì´ìŠˆ ë¶„ì„** (2-4ê°œ ì£¼ìš” ì´ìŠˆ)
   - ê° ì´ìŠˆì˜ ë°°ê²½ê³¼ ë§¥ë½ (ë¬´ìŠ¨ ì¼ì´ ì™œ ì¼ì–´ë‚¬ëŠ”ì§€)
   - í•´ë‹¹ ë¶„ì•¼ì—ì„œì˜ ì˜ë¯¸ì™€ ì˜í–¥ (ê´€ë ¨ ì´í•´ê´€ê³„ì, ìˆ˜ì¹˜, íŒŒê¸‰ íš¨ê³¼)
   - ì´ìŠˆ ê°„ ì—°ê²°ê³ ë¦¬ê°€ ìˆë‹¤ë©´ ë°˜ë“œì‹œ ì–¸ê¸‰
   - ê° ì´ìŠˆë‹¹ 2-3ì¤„ë¡œ ê·¼ê±°ë¥¼ í¬í•¨í•˜ì—¬ ë¶„ì„

3. **ğŸ’¡ ${expertName}ì˜ ì „ë¬¸ ì¸ì‚¬ì´íŠ¸**
   - **í•µì‹¬ í¬ì¸íŠ¸**: ì´ ë‰´ìŠ¤ë“¤ì„ ê´€í†µí•˜ëŠ” ë³¸ì§ˆì  ì˜ë¯¸ (2-3ì¤„)
   - **ì—…ê³„ ë‚´ë¶€ ì‹œê°**: ì¼ë°˜ì¸ì´ ë†“ì¹˜ê¸° ì‰¬ìš´ ì¤‘ìš”í•œ ì  (1-2ì¤„)
   - **ì „ë¬¸ê°€ ì˜ˆì¸¡**: í–¥í›„ ì „ê°œ ë°©í–¥ê³¼ ì‹œë‚˜ë¦¬ì˜¤ (1-2ì¤„)
   - **So What?**: ë…ìê°€ ì´ ë‰´ìŠ¤ì—ì„œ ì‹¤ì§ˆì ìœ¼ë¡œ ì£¼ëª©í•´ì•¼ í•  ê²ƒ (1-2ì¤„)

4. **ğŸ”‘ í•µì‹¬ í‚¤ì›Œë“œ** 5ê°œ

**í‚¤ì›Œë“œ ì„ ì • ê¸°ì¤€:**
- ${categoryName} ë¶„ì•¼ì˜ í•µì‹¬ ìŸì ì´ë‚˜ ê°œë…ì„ ë‚˜íƒ€ë‚´ëŠ” ë‹¨ì–´
- ê´€ë ¨ ë‰´ìŠ¤ë¥¼ ë” ì°¾ì„ ë•Œ ê²€ìƒ‰ì–´ë¡œ ìœ ìš©í•œ ë‹¨ì–´
- ë„ˆë¬´ ì¼ë°˜ì ì¸ ë‹¨ì–´ ëŒ€ì‹  êµ¬ì²´ì ì¸ í‚¤ì›Œë“œ
- í•œê¸€ë¡œë§Œ ì‘ì„±

**ì¶œë ¥ í˜•ì‹ (ë°˜ë“œì‹œ JSON):**
{
  "insights": "ğŸ” **ì˜¤ëŠ˜ì˜ í•œ ì¤„**\\n\\n(í•œ ë¬¸ì¥ ìš”ì•½)\\n\\nğŸ“Š **í•µì‹¬ ì´ìŠˆ ë¶„ì„**\\n\\n**1. [ì´ìŠˆëª…]**\\nâ€¢ (ë¶„ì„ 2-3ì¤„, ë°°ê²½+ì˜ë¯¸+ì˜í–¥)\\n\\n**2. [ì´ìŠˆëª…]**\\nâ€¢ (ë¶„ì„ 2-3ì¤„)\\n\\nğŸ’¡ **${expertName}ì˜ ì „ë¬¸ ì¸ì‚¬ì´íŠ¸**\\n\\n**í•µì‹¬ í¬ì¸íŠ¸**\\nâ€¢ (2-3ì¤„)\\n\\n**ì—…ê³„ ë‚´ë¶€ ì‹œê°**\\nâ€¢ (1-2ì¤„)\\n\\n**ì „ë¬¸ê°€ ì˜ˆì¸¡**\\nâ€¢ (1-2ì¤„)\\n\\n**So What?**\\nâ€¢ (1-2ì¤„)",
  "keywords": ["í‚¤ì›Œë“œ1", "í‚¤ì›Œë“œ2", "í‚¤ì›Œë“œ3", "í‚¤ì›Œë“œ4", "í‚¤ì›Œë“œ5"]
}`
}

// í”„ë¡¬í”„íŠ¸ ìƒì„± í•¨ìˆ˜ (í†µí•©)
function createPrompt(newsText: string, newsCount: number, category: string | null): string {
  if (!category || category === 'general') {
    return createGeneralPrompt(newsText, newsCount)
  }
  return createCategoryPrompt(newsText, newsCount, category)
}

/**
 * POST /api/insight/daily
 *
 * InsightNow API (ì¼ë°˜ JSON ì‘ë‹µ)
 * í˜„ì¬ ë¡œë“œëœ ë‰´ìŠ¤ë“¤ì„ ì¢…í•© ë¶„ì„í•˜ì—¬ ì¸ì‚¬ì´íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
 * Fallback ìˆœì„œ: Groq -> Gemini -> OpenRouter
 *
 * @feature ENABLE_DAILY_INSIGHT
 */
export async function POST(request: NextRequest) {
  // Feature Flag ì²´í¬
  if (!FEATURE_FLAGS.ENABLE_DAILY_INSIGHT) {
    return NextResponse.json(
      { error: 'Daily Insight feature is disabled' },
      { status: 403 }
    )
  }

  try {
    const body = await request.json()
    const newsList: NewsItem[] = body.newsList
    const category: string | null = body.category || null

    // ìœ íš¨ì„± ê²€ì‚¬
    if (!Array.isArray(newsList) || newsList.length < 5) {
      return NextResponse.json(
        { error: 'ìµœì†Œ 5ê°œì˜ ë‰´ìŠ¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.' },
        { status: 400 }
      )
    }

    const categoryName = category ? (CATEGORY_NAMES[category] || category) : 'ì¢…í•©'
    console.log(`[InsightNow] Category: ${categoryName}, News count: ${newsList.length}`)

    // ë‰´ìŠ¤ ë°ì´í„°ë¥¼ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
    const newsText = newsList
      .map(
        (news, index) =>
          `[${index + 1}] [${news.source}] ${news.title}\n   ìš”ì•½: ${news.summary || 'ì—†ìŒ'}`
      )
      .join('\n\n')

    const systemPrompt = getSystemPrompt(category)
    const userPrompt = createPrompt(newsText, newsList.length, category)

    const baseOptions = {
      systemPrompt,
      userPrompt,
      temperature: 0.4,
      maxTokens: 8000,
      primaryField: 'insights',
      logPrefix: '[InsightNow]',
    }

    const { result, provider } = await runWithFallback<InsightResult>(
      [
        {
          provider: 'groq',
          fn: () => callGroqJSON<InsightResult>(baseOptions),
        },
        {
          provider: 'gemini',
          fn: () => callGeminiJSON<InsightResult>({ ...baseOptions, geminiSchema: GEMINI_SCHEMA }),
        },
        {
          provider: 'openrouter',
          fn: () => callOpenRouterJSON<InsightResult>(baseOptions),
        },
      ],
      '[InsightNow]'
    )

    return NextResponse.json({
      success: true,
      data: result,
      provider,
      category: categoryName,
    })
  } catch (error) {
    if (error instanceof AllProvidersFailedError) {
      return NextResponse.json(
        {
          error: 'ëª¨ë“  AI í”„ë¡œë°”ì´ë” ì‹¤íŒ¨',
          details: error.details,
          attempts: error.attempts,
        },
        { status: 500 }
      )
    }

    console.error('[Daily Insight API Error]', error)
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'Unknown error' },
      { status: 500 }
    )
  }
}
